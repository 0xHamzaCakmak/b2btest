<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merkez Urunler | Nebula Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Fraunces:opsz,wght@9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f3ede0;
      --bg-2: #d8f0e3;
      --ink: #13221f;
      --accent: #e86f51;
      --card: rgba(255, 255, 255, 0.74);
      --border: rgba(19, 34, 31, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #fef6d8 0%, transparent 40%),
        radial-gradient(circle at 85% 20%, #d4f6eb 0%, transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 1.2rem;
    }
    .blob {
      position: fixed;
      z-index: -1;
      width: 35vmax;
      aspect-ratio: 1;
      border-radius: 42% 58% 70% 30% / 30% 41% 59% 70%;
      background: color-mix(in srgb, var(--accent) 60%, #fff);
      filter: blur(30px);
      opacity: 0.26;
      animation: drift 14s ease-in-out infinite alternate;
    }
    .blob.one { top: -8vmax; left: -10vmax; }
    .blob.two { bottom: -12vmax; right: -8vmax; animation-delay: 2s; }
    @keyframes drift {
      from { transform: translateY(-10px) rotate(0deg); }
      to { transform: translateY(12px) rotate(18deg); }
    }
    .wrap { width: min(980px, 100%); margin: 0 auto; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: clamp(1rem, 2.2vw, 1.8rem);
      box-shadow: 0 24px 60px rgba(19, 34, 31, 0.12);
    }
    .top {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 1rem;
      align-items: start;
      margin-bottom: 1rem;
    }
    .eyebrow {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .3rem .7rem;
      font-size: .8rem;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.65);
    }
    h1 {
      margin: .7rem 0 .4rem;
      font-family: "Fraunces", serif;
      font-size: clamp(1.85rem, 4.3vw, 2.9rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }
    .nav {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-content: flex-start;
      justify-content: flex-end;
      margin-left: auto;
    }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .75rem;
      background: rgba(255, 255, 255, .72);
      font-weight: 600;
      height: fit-content;
    }
    @media (max-width: 980px) {
      .top {
        grid-template-columns: 1fr;
      }
      .nav {
        justify-content: flex-start;
        margin-left: 0;
      }
    }
    form {
      display: grid;
      gap: .9rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: .8rem;
    }
    .item {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, .65);
      padding: .8rem;
    }
    label {
      display: block;
      font-size: .92rem;
      font-weight: 600;
    }
    input {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .85);
      border-radius: 12px;
      padding: .7rem .8rem;
      font: inherit;
      margin-top: .35rem;
      outline: none;
    }
    .actions {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      border-radius: 12px;
      padding: .82rem 1.05rem;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--ink);
      color: #fff;
    }
    .btn.ghost {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .8);
      color: var(--ink);
    }
    .msg {
      display: none;
      border: 1px solid rgba(19, 34, 31, .2);
      background: rgba(216, 240, 227, .75);
      border-radius: 12px;
      padding: .75rem .85rem;
      font-weight: 600;
    }
    .inline-form {
      display: grid;
      grid-template-columns: 1.1fr .7fr 1fr auto;
      gap: .6rem;
      align-items: end;
    }
    @media (max-width: 760px) {
      .inline-form {
        grid-template-columns: 1fr;
      }
    }
    .hint {
      margin: 0;
      font-size: .88rem;
      color: rgba(19, 34, 31, .75);
    }
    .status-row {
      margin-top: .55rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      font-size: .86rem;
      font-weight: 600;
    }
    .status-badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .15rem .55rem;
      background: rgba(216, 240, 227, .8);
    }
    .status-badge.passive {
      background: rgba(255, 226, 226, .85);
      border-color: rgba(171, 47, 47, .35);
      color: #6e1f1f;
    }
    .toggle-wrap {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      white-space: nowrap;
    }
    .toggle-wrap input[type="checkbox"] {
      margin: 0;
      width: auto;
      padding: 0;
    }
    .item-actions {
      margin-top: .6rem;
      display: flex;
      gap: .5rem;
      justify-content: space-between;
      align-items: center;
    }
    .btn.small {
      padding: .45rem .65rem;
      border-radius: 10px;
      font-size: .82rem;
      font-weight: 700;
    }
    .btn.icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 32px;
      padding: 0;
    }
    .btn.icon svg {
      width: 16px;
      height: 16px;
    }
    .btn.success {
      background: #1c5f4f;
      color: #fff;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .btn:disabled {
      opacity: .65;
      cursor: not-allowed;
    }
    .btn.danger {
      background: #fff0ef;
      border: 1px solid rgba(171, 47, 47, .3);
      color: #7c1d1d;
    }
    .thumb {
      width: 100%;
      height: 110px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .72);
      object-fit: cover;
      display: block;
      margin-bottom: .55rem;
    }
    .thumb.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .82rem;
      font-weight: 700;
      color: rgba(19, 34, 31, .62);
      border-style: dashed;
    }
    .remove-image-wrap {
      margin-top: .45rem;
      font-size: .82rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="wrap">
    <main class="panel">
      <div class="top">
        <div>
          <span class="eyebrow">Merkez Rolu</span>
          <h1>Urunler</h1>
        </div>
        <nav class="nav">
          <a href="merkez.html">Merkez Paneli</a>
          <a href="merkez-urun-fiyat.html">Urunler</a>
          <a href="merkez-subeler.html">Subeler</a>
        </nav>
      </div>

      <form id="priceForm">
        <section class="item">
          <div class="inline-form">
            <label>Yeni Urun Adi
              <input type="text" id="newProductName" placeholder="Orn: Pogaca" maxlength="48">
            </label>
            <label>Baslangic Fiyati (TL)
              <input type="number" id="newProductPrice" min="1" step="1" value="500">
            </label>
            <label>Urun Gorseli
              <input type="file" id="newProductImage" accept="image/*">
            </label>
            <button class="btn ghost" type="button" id="addProductBtn">Urun Ekle</button>
          </div>
          <p class="hint">Eklenen urunler fiyat listesine ve sube siparis ekranina otomatik yansir.</p>
        </section>

        <section class="grid" id="productGrid"></section>

        <div class="actions">
          <button class="btn ghost" type="button" id="allActiveBtn">Tumunu Aktif Yap</button>
          <button class="btn ghost" type="button" id="allPassiveBtn">Tumunu Pasif Yap</button>
          <button class="btn primary" type="submit">Fiyatlari Kaydet</button>
          <button class="btn ghost" type="button" id="resetBtn">Varsayilana Don</button>
        </div>
        <div class="msg" id="saveMsg">Fiyatlar guncellendi. Subeler yeni fiyatlari gorecek.</div>
      </form>
    </main>
  </div>

  <script src="../assets/app-config.js"></script>
  <script src="../assets/role-guard.js"></script>
  <script>
    const priceForm = document.getElementById("priceForm");
    const resetBtn = document.getElementById("resetBtn");
    const saveMsg = document.getElementById("saveMsg");
    const productGrid = document.getElementById("productGrid");
    const addProductBtn = document.getElementById("addProductBtn");
    const allActiveBtn = document.getElementById("allActiveBtn");
    const allPassiveBtn = document.getElementById("allPassiveBtn");
    const newProductName = document.getElementById("newProductName");
    const newProductPrice = document.getElementById("newProductPrice");
    const newProductImage = document.getElementById("newProductImage");
    const cfg = window.APP_CONFIG || {};
    const testMode = !!cfg.TEST_MODE;
    const apiBaseUrl = (cfg.API_BASE_URL || "http://localhost:4000/api").replace(/\/$/, "");
    const sessionKey = cfg.AUTH_SESSION_KEY || "authSession";
    let apiProducts = [];
    let editingProductId = null;
    const defaultProducts = [
      { key: "su_boregi", name: "Su Boregi", price: 700 },
      { key: "peynirli_borek", name: "Peynirli Borek", price: 650 },
      { key: "kiymali_borek", name: "Kiymali Borek", price: 730 },
      { key: "patatesli_borek", name: "Patatesli Borek", price: 610 },
      { key: "ispanakli_borek", name: "Ispanakli Borek", price: 640 },
      { key: "kasarli_borek", name: "Kasarli Borek", price: 680 },
      { key: "kol_boregi", name: "Kol Boregi", price: 760 },
      { key: "karisik_borek", name: "Karisik Borek", price: 790 }
    ];
    const defaultPrices = defaultProducts.reduce(function (acc, product) {
      acc[product.key] = product.price;
      return acc;
    }, {});
    const defaultCatalog = defaultProducts.reduce(function (acc, product) {
      acc[product.key] = product.name;
      return acc;
    }, {});
    const defaultAvailability = defaultProducts.reduce(function (acc, product) {
      acc[product.key] = true;
      return acc;
    }, {});

    function getLivePrices() {
      const raw = localStorage.getItem("productPrices");
      const custom = raw ? JSON.parse(raw) : {};
      return Object.assign({}, defaultPrices, custom);
    }

    function saveCatalog(catalog) {
      localStorage.setItem("productCatalog", JSON.stringify(catalog));
    }

    function getCatalog() {
      const raw = localStorage.getItem("productCatalog");
      const custom = raw ? JSON.parse(raw) : {};
      return Object.assign({}, defaultCatalog, custom);
    }

    function getAvailability() {
      const raw = localStorage.getItem("productAvailability");
      const custom = raw ? JSON.parse(raw) : {};
      return Object.assign({}, defaultAvailability, custom);
    }

    function saveAvailability(data) {
      localStorage.setItem("productAvailability", JSON.stringify(data));
    }

    function slugify(text) {
      return String(text || "")
        .toLowerCase()
        .replaceAll("ğ", "g")
        .replaceAll("ü", "u")
        .replaceAll("ş", "s")
        .replaceAll("ı", "i")
        .replaceAll("ö", "o")
        .replaceAll("ç", "c")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function showMessage(message) {
      saveMsg.style.display = "block";
      saveMsg.textContent = message;
      setTimeout(function () {
        saveMsg.style.display = "none";
        saveMsg.textContent = "Fiyatlar guncellendi. Subeler yeni fiyatlari gorecek.";
      }, 2300);
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function getAuthSession() {
      try {
        return JSON.parse(localStorage.getItem(sessionKey) || "null");
      } catch (_err) {
        return null;
      }
    }

    async function apiRequest(path, options) {
      const session = getAuthSession();
      const token = session && session.accessToken ? session.accessToken : "";
      if (!token) {
        throw new Error("Oturum bilgisi bulunamadi. Lutfen tekrar giris yapin.");
      }

      const response = await fetch(apiBaseUrl + path, Object.assign({}, options || {}, {
        headers: Object.assign(
          { "Content-Type": "application/json", Authorization: "Bearer " + token },
          (options && options.headers) || {}
        )
      }));

      const payload = await response.json().catch(function () { return null; });
      if (!response.ok || !payload || payload.ok !== true) {
        throw new Error((payload && payload.message) || "API islemi basarisiz.");
      }
      return payload.data;
    }

    function fileToBase64(file) {
      return new Promise(function (resolve, reject) {
        const reader = new FileReader();
        reader.onload = function () {
          const result = String(reader.result || "");
          const base64 = result.includes(",") ? result.split(",")[1] : result;
          resolve(base64 || "");
        };
        reader.onerror = function () {
          reject(new Error("Dosya okunamadi."));
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadImageFile(file) {
      if (!file) return null;
      const dataBase64 = await fileToBase64(file);
      if (!dataBase64) throw new Error("Gorsel verisi bos.");
      const uploaded = await apiRequest("/products/upload-image", {
        method: "POST",
        body: JSON.stringify({
          fileName: file.name || "urun.jpg",
          mimeType: file.type || "image/jpeg",
          dataBase64: dataBase64
        })
      });
      return uploaded;
    }

    async function fetchProductsFromApi() {
      const data = await apiRequest("/products", { method: "GET" });
      apiProducts = Array.isArray(data) ? data.slice() : [];
      return apiProducts;
    }

    function renderPriceInputs() {
      if (!testMode) {
        const htmlApi = apiProducts
          .map(function (product) {
            const id = product.id;
            const name = escapeHtml(product.name || "-");
            const value = Number(product.basePrice || 1);
            const isActive = product.isActive !== false;
            const isEditing = editingProductId === id;
            const imageUrl = product.imageUrl ? escapeHtml(product.imageUrl) : "";
            return '' +
              '<article class="item">' +
              (imageUrl
                ? ('<img class="thumb" src="' + imageUrl + '" alt="' + name + '">')
                : '<div class="thumb empty">Gorsel Yok</div>') +
              '<label>Urun Adi<input type="text" maxlength="64" data-product-name-id="' + id + '" value="' + name + '" required' + (isEditing ? "" : " disabled") + '></label>' +
              '<label>Fiyat (TL)<input type="number" min="1" step="1" data-product-id="' + id + '" value="' + value + '" required' + (isEditing ? "" : " disabled") + '></label>' +
              '<label>Gorsel<input type="file" accept="image/*" data-product-image-id="' + id + '"' + (isEditing ? "" : " disabled") + '></label>' +
              (isEditing && imageUrl ? '<label class="remove-image-wrap"><input type="checkbox" data-remove-image-id="' + id + '"> Mevcut resmi kaldir</label>' : '') +
              '<div class="status-row">' +
              '<span class="status-badge ' + (isActive ? "" : "passive") + '" data-status-badge="' + id + '">' + (isActive ? "Aktif" : "Pasif") + '</span>' +
              '<label class="toggle-wrap"><input type="checkbox" data-active-toggle-id="' + id + '"' + (isActive ? " checked" : "") + '> Aktif</label>' +
              '</div>' +
              '<div class="item-actions">' +
              '<button class="btn ghost icon" type="button" data-action="edit" data-product-action-id="' + id + '" title="Duzenle">' +
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
              '<path d="M12 20h9"/>' +
              '<path d="M16.5 3.5a2.1 2.1 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>' +
              '</svg>' +
              '</button>' +
              '<button class="btn small ' + (isEditing ? "success" : "ghost") + '" type="button" data-action="save" data-product-action-id="' + id + '"' + (isEditing ? "" : " disabled") + '>Kaydet</button>' +
              '<button class="btn danger small" type="button" data-action="delete" data-product-action-id="' + id + '">Sil</button>' +
              '</div>' +
              '</article>';
          })
          .join("");
        productGrid.innerHTML = htmlApi;
        return;
      }

      const prices = getLivePrices();
      const catalog = getCatalog();
      const availability = getAvailability();
      const html = Object.entries(catalog)
        .map(function (entry) {
          const key = entry[0];
          const name = escapeHtml(entry[1]);
          const value = Number(prices[key] || defaultPrices[key] || 1);
          const isActive = availability[key] !== false;
          return '' +
            '<article class="item">' +
            '<label>' + name + ' (TL)<input type="number" min="1" step="1" data-product="' + key + '" value="' + value + '" required></label>' +
            '<div class="status-row">' +
            '<span class="status-badge ' + (isActive ? "" : "passive") + '" data-status-badge="' + key + '">' + (isActive ? "Aktif" : "Pasif") + '</span>' +
            '<label class="toggle-wrap"><input type="checkbox" data-active-toggle="' + key + '"' + (isActive ? " checked" : "") + '> Aktif</label>' +
            '</div>' +
            '</article>';
        })
        .join("");
      productGrid.innerHTML = html;
    }

    function getApiDraftById(id) {
      const nameInput = productGrid.querySelector('input[data-product-name-id="' + id + '"]');
      const priceInput = productGrid.querySelector('input[data-product-id="' + id + '"]');
      if (!nameInput || !priceInput) return null;
      const name = String(nameInput.value || "").trim();
      const basePrice = Math.max(1, Number(priceInput.value || 1));
      if (!name || Number.isNaN(basePrice)) return null;
      const removeImageInput = productGrid.querySelector('input[data-remove-image-id="' + id + '"]');
      return {
        name: name,
        basePrice: basePrice,
        removeImage: !!(removeImageInput && removeImageInput.checked)
      };
    }

    async function updateSingleApiProduct(id) {
      const old = apiProducts.find(function (item) { return item.id === id; });
      const draft = getApiDraftById(id);
      if (!old || !draft) {
        throw new Error("Urun bilgisi gecersiz.");
      }
      const payload = {};
      if (String(old.name || "") !== draft.name) payload.name = draft.name;
      if (Number(old.basePrice) !== Number(draft.basePrice)) payload.basePrice = draft.basePrice;
      const imageInput = productGrid.querySelector('input[data-product-image-id="' + id + '"]');
      const selectedFile = imageInput && imageInput.files && imageInput.files[0] ? imageInput.files[0] : null;
      if (selectedFile) {
        const uploaded = await uploadImageFile(selectedFile);
        payload.imageUrl = uploaded.imageUrl;
        payload.imageKey = uploaded.imageKey;
      } else if (draft.removeImage && old.imageKey) {
        payload.removeImage = true;
      }
      if (!Object.keys(payload).length) {
        return false;
      }
      await apiRequest("/products/" + id, {
        method: "PUT",
        body: JSON.stringify(payload)
      });
      return true;
    }

    async function saveForm() {
      if (!testMode) {
        let changedCount = 0;
        for (const product of apiProducts) {
          const changed = await updateSingleApiProduct(product.id);
          if (changed) changedCount += 1;
        }
        await fetchProductsFromApi();
        renderPriceInputs();
        showMessage(changedCount > 0 ? "Urun degisiklikleri kaydedildi." : "Degisiklik yok.");
        return;
      }

      const data = {};
      const availability = getAvailability();
      const inputs = productGrid.querySelectorAll("input[data-product]");
      inputs.forEach(function (input) {
        const key = input.dataset.product;
        data[key] = Math.max(1, Number(input.value || 1));
      });
      productGrid.querySelectorAll("input[data-active-toggle]").forEach(function (toggle) {
        availability[toggle.dataset.activeToggle] = toggle.checked;
      });
      localStorage.setItem("productPrices", JSON.stringify(data));
      saveAvailability(availability);
      showMessage("Fiyatlar guncellendi. Subeler yeni fiyatlari gorecek.");
    }

    async function addNewProduct() {
      const name = String(newProductName.value || "").trim();
      const startPrice = Math.max(1, Number(newProductPrice.value || 0));
      if (!name || Number.isNaN(startPrice)) {
        showMessage("Urun adi ve gecerli bir fiyat girin.");
        return;
      }

      if (!testMode) {
        try {
          let imagePayload = null;
          const selectedFile = newProductImage && newProductImage.files && newProductImage.files[0] ? newProductImage.files[0] : null;
          if (selectedFile) {
            imagePayload = await uploadImageFile(selectedFile);
          }
          await apiRequest("/products", {
            method: "POST",
            body: JSON.stringify({
              name: name,
              basePrice: startPrice,
              imageUrl: imagePayload ? imagePayload.imageUrl : undefined,
              imageKey: imagePayload ? imagePayload.imageKey : undefined
            })
          });
          await fetchProductsFromApi();
          renderPriceInputs();
          newProductName.value = "";
          newProductPrice.value = "500";
          if (newProductImage) newProductImage.value = "";
          showMessage("Yeni urun veritabanina eklendi.");
        } catch (err) {
          showMessage(err.message || "Urun eklenemedi.");
        }
        return;
      }

      const key = slugify(name);
      if (!key) {
        showMessage("Urun adi uygun degil. Lutfen farkli bir ad deneyin.");
        return;
      }

      const catalog = getCatalog();
      if (catalog[key]) {
        showMessage("Bu urun zaten mevcut. Fiyatini alttaki listeden guncelleyebilirsiniz.");
        return;
      }

      const prices = getLivePrices();
      const availability = getAvailability();
      catalog[key] = name;
      prices[key] = startPrice;
      availability[key] = true;
      saveCatalog(catalog);
      localStorage.setItem("productPrices", JSON.stringify(prices));
      saveAvailability(availability);
      renderPriceInputs();
      newProductName.value = "";
      newProductPrice.value = "500";
      showMessage("Yeni urun eklendi ve fiyat listesine alindi.");
    }

    async function setAllActiveState(isActive) {
      if (!testMode) {
        try {
          await apiRequest("/products/status-bulk", {
            method: "PUT",
            body: JSON.stringify({ isActive: !!isActive })
          });
          await fetchProductsFromApi();
          renderPriceInputs();
          showMessage(isActive ? "Tum urunler aktif yapildi." : "Tum urunler pasif yapildi.");
        } catch (err) {
          showMessage(err.message || "Toplu durum guncellenemedi.");
        }
        return;
      }

      const availability = getAvailability();
      const catalog = getCatalog();
      Object.keys(catalog).forEach(function (key) {
        availability[key] = isActive;
      });
      saveAvailability(availability);
      renderPriceInputs();
      showMessage(isActive ? "Tum urunler aktif yapildi." : "Tum urunler pasif yapildi.");
    }

    priceForm.addEventListener("submit", async function (event) {
      event.preventDefault();
      try {
        await saveForm();
      } catch (err) {
        showMessage(err.message || "Fiyatlar kaydedilemedi.");
      }
    });

    resetBtn.addEventListener("click", async function () {
      if (!testMode) {
        try {
          const codeToPrice = defaultProducts.reduce(function (acc, product) {
            acc[product.key] = product.price;
            return acc;
          }, {});

          const updates = apiProducts
            .filter(function (p) { return codeToPrice[p.code] != null; })
            .map(function (p) {
              return apiRequest("/products/" + p.id, {
                method: "PUT",
                body: JSON.stringify({ basePrice: codeToPrice[p.code] })
              });
            });

          await Promise.all(updates);
          await fetchProductsFromApi();
          renderPriceInputs();
          showMessage("Cekirdek urunler varsayilan fiyata donduruldu.");
        } catch (err) {
          showMessage(err.message || "Varsayilan fiyatlara donulemedi.");
        }
        return;
      }

      const prices = getLivePrices();
      Object.keys(defaultPrices).forEach(function (key) {
        prices[key] = defaultPrices[key];
      });
      localStorage.setItem("productPrices", JSON.stringify(prices));
      renderPriceInputs();
      showMessage("Cekirdek urunler varsayilan fiyata donduruldu.");
    });

    addProductBtn.addEventListener("click", function () { addNewProduct(); });
    allActiveBtn.addEventListener("click", function () { setAllActiveState(true); });
    allPassiveBtn.addEventListener("click", function () { setAllActiveState(false); });
    productGrid.addEventListener("click", async function (event) {
      const button = event.target && event.target.closest("button[data-action][data-product-action-id]");
      if (!button || testMode) return;
      const id = button.dataset.productActionId;
      const action = button.dataset.action;
      if (!id || !action) return;

      if (action === "edit") {
        editingProductId = id;
        renderPriceInputs();
        const input = productGrid.querySelector('input[data-product-name-id="' + id + '"]');
        if (input) input.focus();
        showMessage("Kart duzenleme moduna alindi.");
        return;
      }

      if (action === "save") {
        if (editingProductId !== id) {
          showMessage("Once kalem ikonuna basarak karti duzenleme moduna alin.");
          return;
        }
        try {
          const changed = await updateSingleApiProduct(id);
          editingProductId = null;
          await fetchProductsFromApi();
          renderPriceInputs();
          showMessage(changed ? "Urun bilgisi guncellendi." : "Degisiklik yok.");
        } catch (err) {
          showMessage(err.message || "Urun guncellenemedi.");
        }
        return;
      }

      if (action === "delete") {
        const confirmed = window.confirm("Bu urun silinecek. Bu islem geri alinamaz. Devam edilsin mi?");
        if (!confirmed) return;
        try {
          await apiRequest("/products/" + id, { method: "DELETE" });
          if (editingProductId === id) editingProductId = null;
          await fetchProductsFromApi();
          renderPriceInputs();
          showMessage("Urun silindi.");
        } catch (err) {
          showMessage(err.message || "Urun silinemedi.");
        }
      }
    });

    productGrid.addEventListener("change", async function (event) {
      const target = event.target;
      if (!target) return;

      if (!testMode && target.matches("input[data-active-toggle-id]")) {
        const id = target.dataset.activeToggleId;
        try {
          await apiRequest("/products/" + id + "/status", {
            method: "PUT",
            body: JSON.stringify({ isActive: target.checked })
          });
          const item = apiProducts.find(function (p) { return p.id === id; });
          if (item) item.isActive = target.checked;
          const badgeApi = productGrid.querySelector('[data-status-badge="' + id + '"]');
          if (badgeApi) {
            badgeApi.textContent = target.checked ? "Aktif" : "Pasif";
            badgeApi.classList.toggle("passive", !target.checked);
          }
          showMessage(target.checked ? "Urun aktif yapildi." : "Urun pasif yapildi.");
        } catch (err) {
          target.checked = !target.checked;
          showMessage(err.message || "Urun durumu guncellenemedi.");
        }
        return;
      }

      if (!target.matches("input[data-active-toggle]")) return;
      const key = target.dataset.activeToggle;
      const availability = getAvailability();
      availability[key] = target.checked;
      saveAvailability(availability);
      const badge = productGrid.querySelector('[data-status-badge="' + key + '"]');
      if (badge) {
        badge.textContent = target.checked ? "Aktif" : "Pasif";
        badge.classList.toggle("passive", !target.checked);
      }
      showMessage(target.checked ? "Urun aktif yapildi." : "Urun pasif yapildi.");
    });

    if (!testMode) {
      fetchProductsFromApi()
        .then(renderPriceInputs)
        .catch(function (err) {
          showMessage((err && err.message) || "Urunler API'den alinamadi.");
        });
    } else {
      renderPriceInputs();
    }
  </script>
</body>
</html>





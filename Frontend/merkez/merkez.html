<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merkez Paneli | Nebula Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Fraunces:opsz,wght@9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f3ede0;
      --bg-2: #d8f0e3;
      --ink: #13221f;
      --accent: #e86f51;
      --card: rgba(255, 255, 255, 0.74);
      --border: rgba(19, 34, 31, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #fef6d8 0%, transparent 40%),
        radial-gradient(circle at 85% 20%, #d4f6eb 0%, transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 1.2rem;
    }
    .blob {
      position: fixed;
      z-index: -1;
      width: 35vmax;
      aspect-ratio: 1;
      border-radius: 42% 58% 70% 30% / 30% 41% 59% 70%;
      background: color-mix(in srgb, var(--accent) 60%, #fff);
      filter: blur(30px);
      opacity: 0.26;
      animation: drift 14s ease-in-out infinite alternate;
    }
    .blob.one { top: -8vmax; left: -10vmax; }
    .blob.two { bottom: -12vmax; right: -8vmax; animation-delay: 2s; }
    @keyframes drift {
      from { transform: translateY(-10px) rotate(0deg); }
      to { transform: translateY(12px) rotate(18deg); }
    }
    .wrap { width: min(1150px, 100%); margin: 0 auto; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: clamp(1rem, 2.2vw, 1.8rem);
      box-shadow: 0 24px 60px rgba(19, 34, 31, 0.12);
      animation: rise 700ms ease-out both;
    }
    @keyframes rise {
      from { transform: translateY(16px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .top {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .eyebrow {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .3rem .7rem;
      font-size: .8rem;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.65);
    }
    h1 {
      margin: .7rem 0 .3rem;
      font-family: "Fraunces", serif;
      font-size: clamp(1.9rem, 4.4vw, 3rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }
    .nav {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-content: flex-start;
    }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .75rem;
      background: rgba(255, 255, 255, .72);
      font-weight: 600;
      height: fit-content;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: .7rem;
      margin-bottom: .95rem;
    }
    .stat {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, .66);
      padding: .75rem .85rem;
    }
    .stat strong {
      display: block;
      margin-top: .1rem;
      font-size: 1.35rem;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1.45fr .9fr;
      gap: .9rem;
    }
    @media (max-width: 940px) {
      .two-col { grid-template-columns: 1fr; }
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255, 255, 255, .67);
      padding: .9rem;
    }
    .card h3 {
      margin: .1rem 0 .7rem;
      font-size: 1.05rem;
    }
    .toolbar {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
      margin-bottom: .7rem;
      align-items: center;
    }
    .check-wrap {
      display: inline-flex;
      gap: .35rem;
      align-items: center;
      font-weight: 600;
      font-size: .92rem;
      background: rgba(255, 255, 255, .8);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .4rem .55rem;
    }
    .btn {
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .45rem .65rem;
      background: rgba(255, 255, 255, .82);
      color: var(--ink);
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--ink);
      color: #fff;
      border-color: transparent;
    }
    .orders {
      display: grid;
      gap: .6rem;
    }
    details.order {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .84);
      padding: .45rem .6rem;
    }
    summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      justify-content: space-between;
      gap: .8rem;
      align-items: center;
      font-weight: 600;
    }
    summary::-webkit-details-marker { display: none; }
    .subline {
      margin-top: .15rem;
      font-size: .88rem;
      color: rgba(19, 34, 31, .8);
    }
    .summary-left {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
    }
    .summary-right {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
    }
    .status-pill {
      font-size: .78rem;
      padding: .18rem .45rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .8);
    }
    .status-pill.ok {
      background: rgba(216, 240, 227, .95);
    }
    details.order.approved {
      border-color: rgba(74, 140, 92, .45);
      background: rgba(241, 252, 244, .9);
    }
    details.order.pending {
      border-color: rgba(232, 111, 81, .35);
    }
    .mini-stats {
      display: flex;
      gap: .45rem;
      flex-wrap: wrap;
      margin-bottom: .55rem;
    }
    .detail-body {
      margin-top: .6rem;
      border-top: 1px dashed rgba(19, 34, 31, .2);
      padding-top: .55rem;
      font-size: .93rem;
      display: grid;
      gap: .45rem;
    }
    .totals {
      display: grid;
      gap: .5rem;
    }
    .total-row {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .84);
      padding: .55rem .7rem;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
    }
    .empty {
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .64);
      padding: .85rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="wrap">
    <main class="panel">
      <div class="top">
        <div>
          <span class="eyebrow">Merkez Rolu</span>
          <h1>Subelerden Gelen Siparisler</h1>
        </div>
        <nav class="nav">
          <a href="../sube/profil.html">Profil</a>
          <a href="../sube/siparis.html">Siparis Ver</a>
          <a href="../sube/siparislerim.html">Siparislerim</a>
          <a href="merkez.html">Merkez Paneli</a>
          <a href="merkez-urun-fiyat.html">Urunler</a>
          <a href="merkez-subeler.html">Subeler</a>
          <a href="../login.html">Cikis</a>
        </nav>
      </div>

      <section class="stats">
        <article class="stat">Secilen Tarih Siparis Sayisi<strong id="statOrderCount">0</strong></article>
        <article class="stat">Toplam Sube (Secilen Tarih)<strong id="statBranchCount">0</strong></article>
        <article class="stat">Toplam Tepsi (Secilen Tarih)<strong id="statTrayCount">0</strong></article>
        <article class="stat">Toplam Tutar (Secilen Tarih)<strong id="statAmount">0 TL</strong></article>
      </section>

      <section class="two-col">
        <article class="card">
          <h3>Gelen Siparis Listesi (Secilen Tarih)</h3>
          <div class="mini-stats">
            <span class="status-pill">Onay Bekleyen: <strong id="pendingCount">0</strong></span>
            <span class="status-pill ok">Onaylanan: <strong id="approvedCount">0</strong></span>
          </div>
          <div class="toolbar">
            <label class="check-wrap">
              Tarih
              <input type="date" id="dateFilter">
            </label>
            <button class="btn" type="button" id="todayBtn">Bugune Don</button>
            <label class="check-wrap">
              <input type="checkbox" id="selectAllOrders">
              Tumunu Sec
            </label>
            <button class="btn primary" type="button" id="approveSelectedBtn">Secilenleri Onayla</button>
            <button class="btn" type="button" id="approveAllBtn">Tum Siparisleri Onayla</button>
            <button class="btn" type="button" id="refreshBtn">Yenile</button>
          </div>
          <div class="orders" id="ordersList"></div>
        </article>
        <article class="card">
          <h3>Total Uretim Ihtiyaci (Tepsi)</h3>
          <div class="totals" id="totalByProduct"></div>
        </article>
      </section>
    </main>
  </div>

  <script>
    const ordersList = document.getElementById("ordersList");
    const totalByProduct = document.getElementById("totalByProduct");
    const statOrderCount = document.getElementById("statOrderCount");
    const statBranchCount = document.getElementById("statBranchCount");
    const statTrayCount = document.getElementById("statTrayCount");
    const statAmount = document.getElementById("statAmount");
    const selectAllOrders = document.getElementById("selectAllOrders");
    const approveSelectedBtn = document.getElementById("approveSelectedBtn");
    const approveAllBtn = document.getElementById("approveAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const pendingCount = document.getElementById("pendingCount");
    const approvedCount = document.getElementById("approvedCount");
    const dateFilter = document.getElementById("dateFilter");
    const todayBtn = document.getElementById("todayBtn");
    const openOrderNos = new Set();
    let currentFilteredOrders = [];
    let currentProductTotals = {};

    function getOrders() {
      const raw = localStorage.getItem("branchOrders");
      return raw ? JSON.parse(raw) : [];
    }

    function saveOrders(orders) {
      localStorage.setItem("branchOrders", JSON.stringify(orders));
    }

    function formatTL(value) {
      return new Intl.NumberFormat("tr-TR").format(value) + " TL";
    }

    function toDateKey(dateValue) {
      const yyyy = dateValue.getFullYear();
      const mm = String(dateValue.getMonth() + 1).padStart(2, "0");
      const dd = String(dateValue.getDate()).padStart(2, "0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function todayKey() {
      return toDateKey(new Date());
    }

    function orderDateKey(isoText) {
      if (!isoText) return "";
      const d = new Date(isoText);
      if (Number.isNaN(d.getTime())) return "";
      return toDateKey(d);
    }

    function formatDate(isoText) {
      const d = new Date(isoText);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("tr-TR");
    }

    function normalizeStatus(status) {
      if (status === "Onaylandi") return "Onaylandi";
      return "Onay Bekliyor";
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function selectedDateKey() {
      return dateFilter.value || todayKey();
    }

    function setTodayFilter() {
      dateFilter.value = todayKey();
    }

    function render() {
      document.querySelectorAll("details.order[open]").forEach(function (el) {
        openOrderNos.add(el.dataset.orderNo || "");
      });
      const allOrders = getOrders();
      const activeDateKey = selectedDateKey();
      const filteredOrders = allOrders.filter(function (order) {
        return orderDateKey(order.createdAt) === activeDateKey;
      });
      currentFilteredOrders = filteredOrders.slice();

      const branchTotals = {};
      const productTotals = {};
      let totalTray = 0;
      let totalAmount = 0;
      let pending = 0;
      let approved = 0;

      filteredOrders.forEach(function (order) {
        const branch = order.branchName || "Bilinmeyen Sube";
        if (!branchTotals[branch]) {
          branchTotals[branch] = { amount: 0, tray: 0 };
        }
        branchTotals[branch].amount += Number(order.totalAmount || 0);
        branchTotals[branch].tray += Number(order.totalTray || 0);
        totalTray += Number(order.totalTray || 0);
        totalAmount += Number(order.totalAmount || 0);

        (order.items || []).forEach(function (item) {
          const name = item.name || "Urun";
          const qty = Number(item.qty || 0);
          productTotals[name] = (productTotals[name] || 0) + qty;
        });
        if (normalizeStatus(order.status) === "Onaylandi") approved += 1;
        else pending += 1;
      });

      statOrderCount.textContent = String(filteredOrders.length);
      statBranchCount.textContent = String(Object.keys(branchTotals).length);
      statTrayCount.textContent = String(totalTray);
      statAmount.textContent = formatTL(totalAmount);
      pendingCount.textContent = String(pending);
      approvedCount.textContent = String(approved);
      currentProductTotals = Object.assign({}, productTotals);

      if (!filteredOrders.length) {
        ordersList.innerHTML = '<div class="empty">Secilen tarihte henuz siparis yok.</div>';
        totalByProduct.innerHTML = '<div class="empty">Total alani siparis geldikce dolacak.</div>';
        return;
      }

      const ordersHtml = filteredOrders
        .slice()
        .sort(function (a, b) {
          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
        })
        .map(function (order) {
          const statusText = normalizeStatus(order.status);
          const isApproved = statusText === "Onaylandi";
          const isOpen = openOrderNos.has(order.orderNo || "");
          const branch = order.branchName || "Bilinmeyen Sube";
          const itemLines = (order.items || []).map(function (item) {
            return escapeHtml(item.name) + ": " + Number(item.qty || 0) + " tepsi";
          }).join("<br>");
          const branchTotal = branchTotals[branch] ? branchTotals[branch].amount : 0;
          const safeOrderNo = escapeHtml(order.orderNo || "-");
          const safeBranch = escapeHtml(branch);
          const safeDelivery = escapeHtml((order.deliveryDate || "-") + " " + (order.deliveryTime || ""));
          const safeCreated = escapeHtml(formatDate(order.createdAt));
          const safeNote = escapeHtml(order.note || "-");
          const safeStatus = escapeHtml(statusText);
          const safeAmount = escapeHtml(formatTL(Number(order.totalAmount || 0)));

          return '' +
            '<details class="order ' + (isApproved ? "approved" : "pending") + '" data-order-no="' + (order.orderNo || "") + '"' + (isOpen ? " open" : "") + '>' +
            '  <summary>' +
            '    <span class="summary-left">' +
            '      <input class="order-check" type="checkbox" data-order-no="' + (order.orderNo || "") + '"' + (isApproved ? " disabled" : "") + '>' +
            '      <span>' + safeBranch + ' | ' + safeOrderNo + '</span>' +
            '    </span>' +
            '    <span class="summary-right"><span class="status-pill ' + (isApproved ? "ok" : "") + '">' + safeStatus + '</span><span>' + safeAmount + '</span></span>' +
            '  </summary>' +
            '  <div class="subline">Olusturma: ' + safeCreated + ' | Teslimat: ' + safeDelivery + '</div>' +
            '  <div class="detail-body">' +
            '    <div><strong>Siparis Kalemleri:</strong><br>' + itemLines + '</div>' +
            '    <div><strong>Siparis Toplami:</strong> ' + escapeHtml(formatTL(Number(order.totalAmount || 0))) + ' (' + Number(order.totalTray || 0) + ' tepsi)</div>' +
            '    <div><strong>Bu Subenin Secilen Tarih Toplami:</strong> ' + escapeHtml(formatTL(branchTotal)) + '</div>' +
            '    <div><strong>Durum:</strong> <span class="status-pill ' + (isApproved ? "ok" : "") + '">' + safeStatus + '</span></div>' +
            '    <div><button class="btn ' + (isApproved ? "" : "primary") + ' approve-one-btn" type="button" data-order-no="' + (order.orderNo || "") + '"' + (isApproved ? " disabled" : "") + '>' + (isApproved ? "Onaylandi" : "Bu Siparisi Onayla") + '</button></div>' +
            '    <div><strong>Not:</strong> ' + safeNote + '</div>' +
            '  </div>' +
            '</details>';
        })
        .join("");
      ordersList.innerHTML = ordersHtml;

      const totalsHtml = Object.entries(productTotals)
        .sort(function (a, b) { return b[1] - a[1]; })
        .map(function (entry) {
          return '<div class="total-row"><span>' + entry[0] + '</span><span>' + entry[1] + ' tepsi</span></div>';
        })
        .join("");
      totalByProduct.innerHTML = totalsHtml;

      document.querySelectorAll("details.order").forEach(function (detailsEl) {
        detailsEl.addEventListener("toggle", function () {
          const orderNo = detailsEl.dataset.orderNo || "";
          if (!orderNo) return;
          if (detailsEl.open) openOrderNos.add(orderNo);
          else openOrderNos.delete(orderNo);
        });
      });

      document.querySelectorAll(".order-check").forEach(function (checkbox) {
        checkbox.addEventListener("click", function (event) {
          event.stopPropagation();
        });
      });

      document.querySelectorAll(".approve-one-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const orderNo = btn.dataset.orderNo || "";
          if (!orderNo) return;
          approveOrdersByNos([orderNo]);
        });
      });

    }

    function approveOrdersByNos(orderNos) {
      if (!orderNos.length) return;
      const allOrders = getOrders();
      const setNos = new Set(orderNos);
      allOrders.forEach(function (order) {
        if (setNos.has(order.orderNo)) {
          order.status = "Onaylandi";
          openOrderNos.add(order.orderNo || "");
        }
      });
      saveOrders(allOrders);
      render();
    }

    function approveSelected() {
      const selectedNos = Array.from(document.querySelectorAll(".order-check:checked"))
        .map(function (cb) { return cb.dataset.orderNo || ""; })
        .filter(Boolean);
      approveOrdersByNos(selectedNos);
    }

    function approveAllForSelectedDate() {
      const allOrders = getOrders();
      const activeDateKey = selectedDateKey();
      const dateNos = allOrders
        .filter(function (order) { return orderDateKey(order.createdAt) === activeDateKey; })
        .map(function (order) { return order.orderNo; })
        .filter(Boolean);
      approveOrdersByNos(dateNos);
    }

    setTodayFilter();
    render();
    approveSelectedBtn.addEventListener("click", approveSelected);
    approveAllBtn.addEventListener("click", approveAllForSelectedDate);
    refreshBtn.addEventListener("click", render);
    dateFilter.addEventListener("change", function () {
      selectAllOrders.checked = false;
      render();
    });
    todayBtn.addEventListener("click", function () {
      setTodayFilter();
      selectAllOrders.checked = false;
      render();
    });
    selectAllOrders.addEventListener("change", function () {
      const checked = selectAllOrders.checked;
      document.querySelectorAll(".order-check:not(:disabled)").forEach(function (cb) {
        cb.checked = checked;
      });
    });
    window.addEventListener("storage", render);
  </script>
  <script src="../assets/app-config.js"></script>
  <script src="../assets/role-guard.js"></script>
</body>
</html>




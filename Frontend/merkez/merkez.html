<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merkez Paneli | B2B Tedarik</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Fraunces:opsz,wght@9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f3ede0;
      --bg-2: #d8f0e3;
      --ink: #13221f;
      --accent: #e86f51;
      --card: rgba(255, 255, 255, 0.74);
      --border: rgba(19, 34, 31, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #fef6d8 0%, transparent 40%),
        radial-gradient(circle at 85% 20%, #d4f6eb 0%, transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 1.2rem;
    }
    .blob {
      position: fixed;
      z-index: -1;
      width: 35vmax;
      aspect-ratio: 1;
      border-radius: 42% 58% 70% 30% / 30% 41% 59% 70%;
      background: color-mix(in srgb, var(--accent) 60%, #fff);
      filter: blur(30px);
      opacity: 0.26;
      animation: drift 14s ease-in-out infinite alternate;
    }
    .blob.one { top: -8vmax; left: -10vmax; }
    .blob.two { bottom: -12vmax; right: -8vmax; animation-delay: 2s; }
    @keyframes drift {
      from { transform: translateY(-10px) rotate(0deg); }
      to { transform: translateY(12px) rotate(18deg); }
    }
    .wrap { width: min(1150px, 100%); margin: 0 auto; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: clamp(1rem, 2.2vw, 1.8rem);
      box-shadow: 0 24px 60px rgba(19, 34, 31, 0.12);
      animation: rise 700ms ease-out both;
    }
    @keyframes rise {
      from { transform: translateY(16px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .top {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 1rem;
      align-items: start;
      margin-bottom: 1rem;
    }
    h1 {
      margin: 0 0 .3rem;
      font-family: "Fraunces", serif;
      font-size: clamp(1.9rem, 4.4vw, 3rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }
    .nav {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-content: flex-start;
      justify-content: flex-start;
      margin-left: 0;
    }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .75rem;
      background: rgba(255, 255, 255, .72);
      font-weight: 600;
      min-height: 42px;
      display: inline-flex;
      align-items: center;
    }
    @media (max-width: 980px) {
      .top {
        grid-template-columns: 1fr;
      }
      .nav {
        justify-content: flex-start;
        margin-left: 0;
      }
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: .7rem;
      margin-bottom: .95rem;
    }
    .stat {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, .66);
      padding: .75rem .85rem;
    }
    .stat strong {
      display: block;
      margin-top: .1rem;
      font-size: 1.35rem;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1.7fr .65fr;
      gap: .9rem;
    }
    @media (max-width: 940px) {
      .two-col { grid-template-columns: 1fr; }
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255, 255, 255, .67);
      padding: .9rem;
    }
    .card h3 {
      margin: .1rem 0 .7rem;
      font-size: 1.05rem;
    }
    .toolbar {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
      margin-bottom: .7rem;
      align-items: center;
    }
    .orders-controls {
      border: 1px solid rgba(19, 34, 31, .12);
      border-radius: 12px;
      background: rgba(255, 255, 255, .58);
      padding: .6rem;
      margin-bottom: .75rem;
      display: grid;
      gap: .55rem;
    }
    .toolbar-row {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .toolbar-group {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .toolbar-label {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 700;
      color: rgba(19, 34, 31, .72);
      margin-right: .25rem;
    }
    .btn.warn {
      background: rgba(255, 243, 221, .95);
      border-color: rgba(196, 143, 56, .35);
    }
    .btn.success {
      background: rgba(216, 240, 227, .95);
      border-color: rgba(74, 140, 92, .35);
      color: #193726;
    }
    .btn.danger-outline {
      background: rgba(255, 255, 255, .9);
      border-color: rgba(191, 72, 72, .45);
      color: #8f2b2b;
    }
    .orders-list-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .7rem;
      margin-bottom: .35rem;
      padding-left: .15rem;
    }
    .orders-list-head-left {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }
    .orders-list-head-right {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }
    .master-check {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #13221f;
    }
    .master-check-label {
      font-size: .84rem;
      color: rgba(19, 34, 31, .76);
      font-weight: 600;
      user-select: none;
      cursor: pointer;
    }
    @media (max-width: 860px) {
      .toolbar-row {
        justify-content: flex-start;
      }
      .toolbar-label {
        width: 100%;
        margin-bottom: .2rem;
      }
    }
    .check-wrap {
      display: inline-flex;
      gap: .35rem;
      align-items: center;
      font-weight: 600;
      font-size: .92rem;
      background: rgba(255, 255, 255, .8);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .4rem .55rem;
    }
    .btn {
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .45rem .65rem;
      background: rgba(255, 255, 255, .82);
      color: var(--ink);
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--ink);
      color: #fff;
      border-color: transparent;
    }
    .orders {
      display: grid;
      gap: .6rem;
    }
    details.order {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .84);
      padding: .45rem .6rem;
    }
    summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      justify-content: space-between;
      gap: .8rem;
      align-items: center;
      font-weight: 600;
    }
    summary::-webkit-details-marker { display: none; }
    .subline {
      margin-top: .15rem;
      font-size: .88rem;
      color: rgba(19, 34, 31, .8);
    }
    .summary-left {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
    }
    .summary-right {
      display: grid;
      grid-template-columns: 132px 132px minmax(88px, 110px);
      align-items: center;
      gap: .45rem;
      justify-items: start;
      white-space: nowrap;
    }
    .summary-col-amount {
      text-align: left;
      font-weight: 700;
      white-space: nowrap;
    }
    @media (max-width: 760px) {
      .summary-right {
        grid-template-columns: 1fr;
        justify-items: start;
      }
    }
    .status-pill {
      font-size: .78rem;
      padding: .18rem .45rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .8);
      white-space: nowrap;
    }
    .status-pill.ok {
      background: rgba(216, 240, 227, .95);
    }
    .status-pill.reject {
      background: rgba(255, 231, 231, .95);
      border-color: rgba(191, 72, 72, .35);
    }
    .status-pill.partial {
      background: rgba(255, 243, 221, .95);
      border-color: rgba(196, 143, 56, .35);
    }
    details.order.approved {
      border-color: rgba(74, 140, 92, .45);
      background: rgba(241, 252, 244, .9);
    }
    details.order.pending {
      border-color: rgba(232, 111, 81, .35);
    }
    details.order.rejected {
      border-color: rgba(191, 72, 72, .35);
      background: rgba(255, 246, 246, .92);
    }
    .mini-stats {
      display: flex;
      gap: .45rem;
      flex-wrap: wrap;
      margin-bottom: .55rem;
    }
    .detail-body {
      margin-top: .6rem;
      border-top: 1px dashed rgba(19, 34, 31, .2);
      padding-top: .55rem;
      font-size: .93rem;
      display: grid;
      gap: .45rem;
    }
    .item-table-wrap {
      overflow: auto;
      border: 1px solid rgba(19, 34, 31, .12);
      border-radius: 10px;
      background: rgba(255, 255, 255, .88);
    }
    .item-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 560px;
    }
    .item-table th,
    .item-table td {
      border-bottom: 1px solid rgba(19, 34, 31, .1);
      padding: .36rem .45rem;
      text-align: left;
      font-size: .86rem;
      vertical-align: middle;
    }
    .item-table th {
      background: rgba(255, 255, 255, .96);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .item-status-pill {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .12rem .42rem;
      background: rgba(255, 255, 255, .9);
      font-size: .75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .item-status-pill.ok {
      background: rgba(216, 240, 227, .95);
    }
    .item-status-pill.reject {
      background: rgba(255, 231, 231, .95);
      border-color: rgba(191, 72, 72, .35);
    }
    .item-status-pill.partial {
      background: rgba(255, 243, 221, .95);
      border-color: rgba(196, 143, 56, .35);
    }
    .totals {
      display: grid;
      gap: .5rem;
    }
    .total-row {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .84);
      padding: .55rem .7rem;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
    }
    .empty {
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, .64);
      padding: .85rem;
      font-weight: 600;
    }
    .dialog-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: rgba(19, 34, 31, .28);
      backdrop-filter: blur(2px);
      z-index: 70;
    }
    .dialog-overlay.show {
      display: flex;
    }
    .dialog-card {
      width: min(420px, 100%);
      border-radius: 14px;
      border: 1px solid rgba(19, 34, 31, .18);
      background: rgba(255, 255, 255, .97);
      box-shadow: 0 18px 36px rgba(19, 34, 31, .24);
      padding: .95rem 1rem;
    }
    .dialog-title {
      margin: 0 0 .35rem;
      font-size: 1.05rem;
    }
    .dialog-text {
      margin: 0;
      font-size: .94rem;
      line-height: 1.4;
      color: rgba(19, 34, 31, .9);
    }
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: .55rem;
      margin-top: .85rem;
    }
  </style>
</head>
<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="wrap">
    <main class="panel">
      <div class="top">
        <div>
          <h1>Bugünün Siparisleri</h1>
        </div>
        <nav class="nav">
          <a href="../sube/siparis.html">Sipariş Ver</a>
          <a href="../sube/siparislerim.html">Siparişlerim</a>
          <a href="merkez.html">Merkez Paneli</a>
          <a href="merkez-raporlar.html">Raporlar</a>
          <a href="merkez-urun-fiyat.html">Ürünler</a>
          <a href="merkez-subeler.html">Şubeler</a>
        </nav>
      </div>

      <section class="stats">
        <article class="stat">Secilen Tarih Siparis Sayisi<strong id="statOrderCount">0</strong></article>
        <article class="stat">Toplam Sube (Secilen Tarih)<strong id="statBranchCount">0</strong></article>
        <article class="stat">Toplam Tepsi (Secilen Tarih)<strong id="statTrayCount">0</strong></article>
        <article class="stat">Toplam Tutar (Secilen Tarih)<strong id="statAmount">0 TL</strong></article>
      </section>

      <section class="two-col">
        <article class="card">
          <h3>Gelen Siparis Listesi (Secilen Tarih)</h3>
          <div class="mini-stats">
            <span class="status-pill">Onay Bekleyen: <strong id="pendingCount">0</strong></span>
            <span class="status-pill ok">Onaylanan: <strong id="approvedCount">0</strong></span>
            <span class="status-pill">Kismen Onay: <strong id="partialCount">0</strong></span>
            <span class="status-pill reject">Onaylanmadi: <strong id="rejectedCount">0</strong></span>
            <span class="status-pill ok">Teslim Edilen: <strong id="deliveredCount">0</strong></span>
          </div>
          <div class="orders-controls">
            <div class="toolbar-row">
              <div class="toolbar-group">
                <span class="toolbar-label">Filtre</span>
                <label class="check-wrap">
                  Tarih
                  <input type="date" id="dateFilter">
                </label>
                <button class="btn" type="button" id="todayBtn">Bugune Don</button>
                <button class="btn" type="button" id="refreshBtn">Yenile</button>
              </div>
            </div>
            <div class="toolbar-row">
              <div class="toolbar-group">
                <span class="toolbar-label">Onay Islemleri</span>
                <button class="btn primary" type="button" id="approveSelectedBtn">Secilenleri Onayla</button>
                <button class="btn danger-outline" type="button" id="rejectSelectedBtn">Secilenleri Reddet</button>
                <button class="btn warn" type="button" id="approveAllBtn">Tum Siparisleri Onayla</button>
              </div>
            </div>
          </div>
          <div class="orders-list-head">
            <div class="orders-list-head-left">
              <input id="selectAllOrders" class="master-check" type="checkbox" aria-label="Listede bekleyen siparislerin tumunu sec">
              <label class="master-check-label" for="selectAllOrders">Tum siparisleri sec</label>
            </div>
            <div class="orders-list-head-right">
              <button class="btn warn" type="button" id="deliverAllBtn">Tamami Teslim Edildi</button>
            </div>
          </div>
          <div class="orders" id="ordersList"></div>
        </article>
        <article class="card">
          <h3>Total Uretim Ihtiyaci (Tepsi)</h3>
          <div class="totals" id="totalByProduct"></div>
        </article>
      </section>
    </main>
  </div>
  <div id="dialogOverlay" class="dialog-overlay">
    <div class="dialog-card">
      <h3 id="dialogTitle" class="dialog-title">Onay</h3>
      <p id="dialogText" class="dialog-text"></p>
      <div class="dialog-actions">
        <button id="dialogCancelBtn" class="btn" type="button">Vazgec</button>
        <button id="dialogConfirmBtn" class="btn primary" type="button">Tamam</button>
      </div>
    </div>
  </div>

  <script src="../assets/app-config.js"></script>
  <script src="../assets/role-guard.js"></script>
  <script>
    const ordersList = document.getElementById("ordersList");
    const totalByProduct = document.getElementById("totalByProduct");
    const statOrderCount = document.getElementById("statOrderCount");
    const statBranchCount = document.getElementById("statBranchCount");
    const statTrayCount = document.getElementById("statTrayCount");
    const statAmount = document.getElementById("statAmount");
    const selectAllOrders = document.getElementById("selectAllOrders");
    const approveSelectedBtn = document.getElementById("approveSelectedBtn");
    const rejectSelectedBtn = document.getElementById("rejectSelectedBtn");
    const approveAllBtn = document.getElementById("approveAllBtn");
    const deliverAllBtn = document.getElementById("deliverAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const pendingCount = document.getElementById("pendingCount");
    const approvedCount = document.getElementById("approvedCount");
    const partialCount = document.getElementById("partialCount");
    const rejectedCount = document.getElementById("rejectedCount");
    const deliveredCount = document.getElementById("deliveredCount");
    const dateFilter = document.getElementById("dateFilter");
    const todayBtn = document.getElementById("todayBtn");
    const dialogOverlay = document.getElementById("dialogOverlay");
    const dialogTitle = document.getElementById("dialogTitle");
    const dialogText = document.getElementById("dialogText");
    const dialogCancelBtn = document.getElementById("dialogCancelBtn");
    const dialogConfirmBtn = document.getElementById("dialogConfirmBtn");
    const openOrderNos = new Set();
    let currentFilteredOrders = [];
    let currentProductTotals = {};
    const cfg = window.APP_CONFIG || {};
    const apiBaseUrl = (cfg.API_BASE_URL || "http://localhost:4000/api").replace(/\/$/, "");
    function getAuthSession() {
      try {
        return window.AuthSession && window.AuthSession.get ? window.AuthSession.get() : null;
      } catch (_err) {
        return null;
      }
    }

    async function apiRequest(path, options) {
      const session = getAuthSession();
      const response = await fetch(apiBaseUrl + path, Object.assign({}, options || {}, {
        credentials: "include",
        headers: Object.assign(
          { "Content-Type": "application/json" },
          (options && options.headers) || {}
        )
      }));
      const payload = await response.json().catch(function () { return null; });
      if (!response.ok || !payload || payload.ok !== true) {
        throw new Error((payload && payload.message) || "API islemi basarisiz.");
      }
      return payload.data;
    }

    function formatTL(value) {
      return new Intl.NumberFormat("tr-TR").format(value) + " TL";
    }

    function toDateKey(dateValue) {
      const yyyy = dateValue.getFullYear();
      const mm = String(dateValue.getMonth() + 1).padStart(2, "0");
      const dd = String(dateValue.getDate()).padStart(2, "0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function todayKey() {
      return toDateKey(new Date());
    }

    function formatDate(isoText) {
      const d = new Date(isoText);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("tr-TR");
    }

    function normalizeStatus(status) {
      if (status === "Onaylandi") return "Onaylandi";
      if (status === "Kismen Onaylandi") return "Kismen Onaylandi";
      if (status === "Onaylanmadi") return "Onaylanmadi";
      return "Onay Bekliyor";
    }

    function normalizeDeliveryStatus(status) {
      if (String(status || "").toLowerCase() === "teslim edildi") return "Teslim Edildi";
      return "Teslim Bekliyor";
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function showConfirmDialog(title, text, confirmText, cancelText) {
      return new Promise(function (resolve) {
        dialogTitle.textContent = title || "Onay";
        dialogText.textContent = text || "";
        dialogConfirmBtn.textContent = confirmText || "Tamam";
        dialogCancelBtn.textContent = cancelText || "Vazgec";
        dialogCancelBtn.style.display = "";
        dialogOverlay.classList.add("show");

        function cleanup() {
          dialogOverlay.classList.remove("show");
          dialogConfirmBtn.removeEventListener("click", onConfirm);
          dialogCancelBtn.removeEventListener("click", onCancel);
          dialogOverlay.removeEventListener("click", onOverlay);
          document.removeEventListener("keydown", onEsc);
        }
        function onConfirm() {
          cleanup();
          resolve(true);
        }
        function onCancel() {
          cleanup();
          resolve(false);
        }
        function onOverlay(event) {
          if (event.target !== dialogOverlay) return;
          cleanup();
          resolve(false);
        }
        function onEsc(event) {
          if (event.key !== "Escape") return;
          cleanup();
          resolve(false);
        }

        dialogConfirmBtn.addEventListener("click", onConfirm);
        dialogCancelBtn.addEventListener("click", onCancel);
        dialogOverlay.addEventListener("click", onOverlay);
        document.addEventListener("keydown", onEsc);
      });
    }

    function showInfoDialog(title, text, buttonText) {
      return new Promise(function (resolve) {
        dialogTitle.textContent = title || "Bilgi";
        dialogText.textContent = text || "";
        dialogConfirmBtn.textContent = buttonText || "Kapat";
        dialogCancelBtn.style.display = "none";
        dialogOverlay.classList.add("show");

        function cleanup() {
          dialogOverlay.classList.remove("show");
          dialogConfirmBtn.removeEventListener("click", onClose);
          dialogOverlay.removeEventListener("click", onOverlay);
          document.removeEventListener("keydown", onEsc);
          dialogCancelBtn.style.display = "";
        }
        function onClose() {
          cleanup();
          resolve();
        }
        function onOverlay(event) {
          if (event.target !== dialogOverlay) return;
          cleanup();
          resolve();
        }
        function onEsc(event) {
          if (event.key !== "Escape") return;
          cleanup();
          resolve();
        }

        dialogConfirmBtn.addEventListener("click", onClose);
        dialogOverlay.addEventListener("click", onOverlay);
        document.addEventListener("keydown", onEsc);
      });
    }

    function selectedDateKey() {
      return dateFilter.value || todayKey();
    }

    function setTodayFilter() {
      dateFilter.value = todayKey();
    }

    async function render() {
      document.querySelectorAll("details.order[open]").forEach(function (el) {
        openOrderNos.add(el.dataset.orderNo || "");
      });
      const activeDateKey = selectedDateKey();
      let filteredOrders = [];
      try {
        filteredOrders = await apiRequest("/orders?date=" + encodeURIComponent(activeDateKey), { method: "GET" });
      } catch (err) {
        ordersList.innerHTML = '<div class="empty">' + ((err && err.message) || "Siparisler alinamadi.") + '</div>';
        totalByProduct.innerHTML = '<div class="empty">Total alani siparis geldikce dolacak.</div>';
        return;
      }
      currentFilteredOrders = filteredOrders.slice();

      const branchTotals = {};
      const productTotals = {};
      let totalTray = 0;
      let totalAmount = 0;
      let pending = 0;
      let approved = 0;
      let partial = 0;
      let rejected = 0;
      let delivered = 0;
      let approvableOrderCount = 0;
      let deliveryPendingCount = 0;

      filteredOrders.forEach(function (order) {
        const branch = order.branchName || "Bilinmeyen Sube";
        if (!branchTotals[branch]) {
          branchTotals[branch] = { amount: 0, tray: 0 };
        }
        branchTotals[branch].amount += Number(order.totalAmount || 0);
        branchTotals[branch].tray += Number(order.totalTray || 0);
        totalTray += Number(order.totalTray || 0);
        totalAmount += Number(order.totalAmount || 0);

        (order.items || []).forEach(function (item) {
          const name = item.name || "Urun";
          const qty = Number(item.qty || 0);
          productTotals[name] = (productTotals[name] || 0) + qty;
        });
        const normalizedStatus = normalizeStatus(order.status);
        if (normalizedStatus === "Onaylandi") approved += 1;
        else if (normalizedStatus === "Kismen Onaylandi") partial += 1;
        else if (normalizedStatus === "Onaylanmadi") rejected += 1;
        else pending += 1;
        const normalizedDelivery = normalizeDeliveryStatus(order.deliveryStatus);
        if (normalizedDelivery === "Teslim Edildi") delivered += 1;
        if (normalizedStatus === "Onaylandi" || normalizedStatus === "Kismen Onaylandi") {
          approvableOrderCount += 1;
          if (normalizedDelivery !== "Teslim Edildi") deliveryPendingCount += 1;
        }
      });

      statOrderCount.textContent = String(filteredOrders.length);
      statBranchCount.textContent = String(Object.keys(branchTotals).length);
      statTrayCount.textContent = String(totalTray);
      statAmount.textContent = formatTL(totalAmount);
      pendingCount.textContent = String(pending);
      approvedCount.textContent = String(approved);
      partialCount.textContent = String(partial);
      rejectedCount.textContent = String(rejected);
      deliveredCount.textContent = String(delivered);
      updateApproveAllButtonState(pending, partial, rejected, approved);
      updateDeliverAllButtonState(approvableOrderCount, deliveryPendingCount);
      currentProductTotals = Object.assign({}, productTotals);

      if (!filteredOrders.length) {
        ordersList.innerHTML = '<div class="empty">Secilen tarihte henuz siparis yok.</div>';
        totalByProduct.innerHTML = '<div class="empty">Total alani siparis geldikce dolacak.</div>';
        updateApproveAllButtonState(0, 0, 0, 0);
        updateDeliverAllButtonState(0, 0);
        return;
      }

      const ordersHtml = filteredOrders
        .slice()
        .sort(function (a, b) {
          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
        })
        .map(function (order) {
          const statusText = normalizeStatus(order.status);
          const isApproved = statusText === "Onaylandi";
          const isPartial = statusText === "Kismen Onaylandi";
          const isRejected = statusText === "Onaylanmadi";
          const isPending = statusText === "Onay Bekliyor";
          const deliveryText = normalizeDeliveryStatus(order.deliveryStatus);
          const isDelivered = deliveryText === "Teslim Edildi";
          const isOpen = openOrderNos.has(order.orderNo || "");
          const branch = order.branchName || "Bilinmeyen Sube";
          const itemLines = (order.items || []).map(function (item) {
            const itemStatus = String(item.itemStatus || (isPending ? "Onay Bekliyor" : (isRejected ? "Onaylanmadi" : "Onaylandi")));
            const itemStatusClass = itemStatus === "Onaylandi"
              ? "ok"
              : (itemStatus === "Onaylanmadi" ? "reject" : (itemStatus === "Kismen Onaylandi" ? "partial" : ""));
            const requestedQty = Number(item.qty || 0);
            const approvedQty = item.approvedQty === null || item.approvedQty === undefined ? "-" : String(Number(item.approvedQty));
            const rowChecked = isPending ? " checked" : ((itemStatus === "Onaylandi" || itemStatus === "Kismen Onaylandi") ? " checked" : "");
            const rowDisabled = isPending ? "" : " disabled";
            return '' +
              '<tr>' +
              '<td>' + escapeHtml(item.name || "-") + '</td>' +
              '<td>' + requestedQty + '</td>' +
              '<td>' + escapeHtml(approvedQty) + '</td>' +
              '<td>' + escapeHtml(formatTL(Number(item.unitPrice || 0))) + '</td>' +
              '<td><span class="item-status-pill ' + itemStatusClass + '">' + escapeHtml(itemStatus) + '</span></td>' +
              '<td><input class="item-check" type="checkbox" data-order-no="' + (order.orderNo || "") + '" data-item-id="' + (item.id || "") + '"' + rowChecked + rowDisabled + '></td>' +
              '</tr>';
          }).join("");
          const carryoverLines = (order.carryovers || []).map(function (entry) {
            return escapeHtml(entry.name) + ": " + Number(entry.qtyKg || 0) + " kg";
          }).join("<br>");
          const branchTotal = branchTotals[branch] ? branchTotals[branch].amount : 0;
          const safeOrderNo = escapeHtml(order.orderNo || "-");
          const safeBranch = escapeHtml(branch);
          const safeDelivery = escapeHtml((order.deliveryDate || "-") + " " + (order.deliveryTime || ""));
          const safeCreated = escapeHtml(formatDate(order.createdAt));
          const safeNote = escapeHtml(order.note || "-");
          const safeStatus = escapeHtml(statusText);
          const safeDeliveryStatus = escapeHtml(deliveryText);
          const safeAmount = escapeHtml(formatTL(Number(order.totalAmount || 0)));
          const safeDeliveredAt = escapeHtml(formatDate(order.deliveredAt));
          const safeDeliveredBy = escapeHtml(order.deliveredByName || "-");
          const deliveryBtnDisabled = ((!isApproved && !isPartial) || isDelivered) ? " disabled" : "";
          const deliveryBtnText = isDelivered ? "Teslim Edildi" : "Teslim Edildi Isaretle";
          const orderStateClass = (isApproved || isPartial) ? "approved" : (isRejected ? "rejected" : "pending");
          const statusClass = isApproved ? "ok" : (isPartial ? "partial" : (isRejected ? "reject" : ""));
          const deliveryClass = isDelivered ? "ok" : "partial";
          const checkboxDisabled = !isPending ? " disabled" : "";
          const checkboxChecked = isPending ? " checked" : "";
          const approveBtnDisabled = !isPending ? " disabled" : "";
          const approveBtnClass = isPending ? "primary" : "";
          const rejectBtnDisabled = !isPending ? " disabled" : "";
          const approveBtnText = (isApproved || isPartial)
            ? (isPartial ? "Kismen Onaylandi" : "Onaylandi")
            : (isRejected ? "Onaylanmadi" : "Bu Siparisi Onayla");
          const rejectBtnText = isRejected ? "Onaylanmadi" : "Bu Siparisi Reddet";

          return '' +
            '<details class="order ' + orderStateClass + '" data-order-no="' + (order.orderNo || "") + '"' + (isOpen ? " open" : "") + '>' +
            '  <summary>' +
            '    <span class="summary-left">' +
            '      <input class="order-check" type="checkbox" data-order-no="' + (order.orderNo || "") + '"' + checkboxDisabled + checkboxChecked + '>' +
            '      <span>' + safeBranch + ' | ' + safeOrderNo + '</span>' +
            '    </span>' +
            '    <span class="summary-right"><span class="status-pill ' + statusClass + '">' + safeStatus + '</span><span class="status-pill ' + deliveryClass + '">' + safeDeliveryStatus + '</span><span class="summary-col-amount">' + safeAmount + '</span></span>' +
            '  </summary>' +
            '  <div class="subline">Olusturma: ' + safeCreated + ' | Teslimat: ' + safeDelivery + '</div>' +
            '  <div class="detail-body">' +
            '    <div><strong>Siparis Kalemleri:</strong></div>' +
            '    <div class="item-table-wrap"><table class="item-table"><thead><tr><th>Urun</th><th>Talep</th><th>Onaylanan</th><th>Birim Fiyat</th><th>Durum</th><th>Onay</th></tr></thead><tbody>' + itemLines + '</tbody></table></div>' +
            (carryoverLines ? '    <div><strong>Elde Kalan (Dunden):</strong><br>' + carryoverLines + '</div>' : '') +
            '    <div><strong>Siparis Toplami:</strong> ' + escapeHtml(formatTL(Number(order.totalAmount || 0))) + ' (' + Number(order.totalTray || 0) + ' tepsi)</div>' +
            '    <div><strong>Bu Subenin Secilen Tarih Toplami:</strong> ' + escapeHtml(formatTL(branchTotal)) + '</div>' +
            '    <div><strong>Durum:</strong> <span class="status-pill ' + statusClass + '">' + safeStatus + '</span></div>' +
            '    <div><strong>Teslimat Durumu:</strong> <span class="status-pill ' + (isDelivered ? "ok" : "") + '">' + safeDeliveryStatus + '</span>' + (isDelivered ? (' | <strong>Teslim:</strong> ' + safeDeliveredAt + ' | <strong>Yetkili:</strong> ' + safeDeliveredBy) : '') + '</div>' +
            '    <div><button class="btn ' + approveBtnClass + ' approve-one-btn" type="button" data-order-no="' + (order.orderNo || "") + '"' + approveBtnDisabled + '>' + approveBtnText + '</button> <button class="btn danger-outline reject-one-btn" type="button" data-order-no="' + (order.orderNo || "") + '"' + rejectBtnDisabled + '>' + rejectBtnText + '</button> <button class="btn ' + (isDelivered ? "" : "primary") + ' deliver-one-btn" type="button" data-order-no="' + (order.orderNo || "") + '"' + deliveryBtnDisabled + '>' + deliveryBtnText + '</button></div>' +
            '    <div><strong>Not:</strong> ' + safeNote + '</div>' +
            '  </div>' +
            '</details>';
        })
        .join("");
      ordersList.innerHTML = ordersHtml;

      const totalsHtml = Object.entries(productTotals)
        .sort(function (a, b) { return b[1] - a[1]; })
        .map(function (entry) {
          return '<div class="total-row"><span>' + entry[0] + '</span><span>' + entry[1] + ' tepsi</span></div>';
        })
        .join("");
      totalByProduct.innerHTML = totalsHtml;

      document.querySelectorAll("details.order").forEach(function (detailsEl) {
        detailsEl.addEventListener("toggle", function () {
          const orderNo = detailsEl.dataset.orderNo || "";
          if (!orderNo) return;
          if (detailsEl.open) openOrderNos.add(orderNo);
          else openOrderNos.delete(orderNo);
        });
      });

      document.querySelectorAll(".order-check").forEach(function (checkbox) {
        checkbox.addEventListener("click", function (event) {
          event.stopPropagation();
        });
        checkbox.addEventListener("change", syncSelectAllState);
      });
      document.querySelectorAll(".item-check").forEach(function (checkbox) {
        checkbox.addEventListener("click", function (event) {
          event.stopPropagation();
        });
      });
      syncSelectAllState();

      document.querySelectorAll(".approve-one-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const orderNo = btn.dataset.orderNo || "";
          if (!orderNo) return;
          approveOrdersByNos([orderNo]);
        });
      });
      document.querySelectorAll(".reject-one-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const orderNo = btn.dataset.orderNo || "";
          if (!orderNo) return;
          rejectOrdersByNos([orderNo]);
        });
      });
      document.querySelectorAll(".deliver-one-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const orderNo = btn.dataset.orderNo || "";
          if (!orderNo) return;
          deliverOrdersByNos([orderNo]);
        });
      });

    }

    async function approveOrdersByNos(orderNos) {
      if (!orderNos.length) return;
      const setNos = new Set(orderNos);
      const selectedOrders = currentFilteredOrders.filter(function (order) {
        return setNos.has(order.orderNo);
      });
      const orderItemDecisions = selectedOrders
        .filter(function (order) { return normalizeStatus(order.status) === "Onay Bekliyor"; })
        .map(function (order) {
          const itemCheckboxes = Array.from(document.querySelectorAll('.item-check[data-order-no="' + (order.orderNo || "") + '"]'));
          const approveItemIds = itemCheckboxes
            .filter(function (cb) { return cb.checked; })
            .map(function (cb) { return cb.dataset.itemId || ""; })
            .filter(Boolean);
          const rejectItemIds = itemCheckboxes
            .filter(function (cb) { return !cb.checked; })
            .map(function (cb) { return cb.dataset.itemId || ""; })
            .filter(Boolean);
          const fallbackIds = (order.items || []).map(function (item) { return item.id; }).filter(Boolean);
          return {
            orderId: order.id,
            approveItemIds: itemCheckboxes.length ? approveItemIds : fallbackIds,
            rejectItemIds: itemCheckboxes.length ? rejectItemIds : []
          };
        });
      if (!orderItemDecisions.length) return;

      try {
        await apiRequest("/orders/approve-bulk", {
          method: "PUT",
          body: JSON.stringify({ orderItemDecisions: orderItemDecisions })
        });
        orderNos.forEach(function (no) { openOrderNos.add(no || ""); });
        await render();
      } catch (_err) {}
    }

    async function approveSelected() {
      await processBulkApprovalByCheckboxes();
    }

    async function rejectSelected() {
      const selectedOrderNos = Array.from(document.querySelectorAll(".order-check:checked:not(:disabled)"))
        .map(function (cb) { return cb.dataset.orderNo || ""; })
        .filter(Boolean);
      if (!selectedOrderNos.length) return;
      await rejectOrdersByNos(selectedOrderNos);
    }

    async function approveAllForSelectedDate() {
      await processBulkApprovalByCheckboxes();
    }

    async function rejectOrdersByNos(orderNos) {
      if (!orderNos.length) return;
      const setNos = new Set(orderNos);
      const orderItemDecisions = currentFilteredOrders
        .filter(function (order) {
          return setNos.has(order.orderNo) && normalizeStatus(order.status) === "Onay Bekliyor";
        })
        .map(function (order) {
          return {
            orderId: order.id,
            approveItemIds: [],
            rejectItemIds: (order.items || []).map(function (item) { return item.id; }).filter(Boolean)
          };
        });
      if (!orderItemDecisions.length) return;

      try {
        await apiRequest("/orders/approve-bulk", {
          method: "PUT",
          body: JSON.stringify({ orderItemDecisions: orderItemDecisions })
        });
        orderNos.forEach(function (no) { openOrderNos.add(no || ""); });
        await render();
      } catch (_err) {}
    }

    function syncSelectAllState() {
      const checkboxes = Array.from(document.querySelectorAll(".order-check:not(:disabled)"));
      if (!checkboxes.length) {
        selectAllOrders.checked = false;
        selectAllOrders.indeterminate = false;
        return;
      }
      const checkedCount = checkboxes.filter(function (cb) { return cb.checked; }).length;
      if (checkedCount === 0) {
        selectAllOrders.checked = false;
        selectAllOrders.indeterminate = false;
      } else if (checkedCount === checkboxes.length) {
        selectAllOrders.checked = true;
        selectAllOrders.indeterminate = false;
      } else {
        selectAllOrders.checked = false;
        selectAllOrders.indeterminate = true;
      }
    }

    function collectPendingDecisionIds() {
      const checkboxMap = new Map();
      document.querySelectorAll(".order-check:not(:disabled)").forEach(function (cb) {
        const orderNo = cb.dataset.orderNo || "";
        if (!orderNo) return;
        checkboxMap.set(orderNo, !!cb.checked);
      });
      const orderItemDecisions = [];
      const approveOrderNos = [];
      const rejectOrderNos = [];
      currentFilteredOrders.forEach(function (order) {
        const key = order.orderNo || "";
        if (!checkboxMap.has(key)) return;
        if (!order.id) return;
        if (!checkboxMap.get(key)) {
          rejectOrderNos.push(key);
          orderItemDecisions.push({
            orderId: order.id,
            approveItemIds: [],
            rejectItemIds: (order.items || []).map(function (item) { return item.id; }).filter(Boolean)
          });
          return;
        }
        approveOrderNos.push(key);
        const itemCheckboxes = Array.from(document.querySelectorAll('.item-check[data-order-no="' + key + '"]'));
        const approveItemIds = itemCheckboxes
          .filter(function (cb) { return cb.checked; })
          .map(function (cb) { return cb.dataset.itemId || ""; })
          .filter(Boolean);
        const rejectItemIds = itemCheckboxes
          .filter(function (cb) { return !cb.checked; })
          .map(function (cb) { return cb.dataset.itemId || ""; })
          .filter(Boolean);
        if (!itemCheckboxes.length) {
          const ids = (order.items || []).map(function (item) { return item.id; }).filter(Boolean);
          orderItemDecisions.push({
            orderId: order.id,
            approveItemIds: ids,
            rejectItemIds: []
          });
        } else {
          orderItemDecisions.push({
            orderId: order.id,
            approveItemIds: approveItemIds,
            rejectItemIds: rejectItemIds
          });
        }
      });
      return {
        approveIds: [],
        rejectIds: [],
        orderItemDecisions: orderItemDecisions,
        approveOrderNos: approveOrderNos,
        rejectOrderNos: rejectOrderNos
      };
    }

    async function processBulkApprovalByCheckboxes() {
      const ids = collectPendingDecisionIds();
      if (!ids.orderItemDecisions.length && !ids.approveIds.length && !ids.rejectIds.length) return;
      try {
        await apiRequest("/orders/approve-bulk", {
          method: "PUT",
          body: JSON.stringify({
            approveIds: ids.approveIds,
            rejectIds: ids.rejectIds,
            orderItemDecisions: ids.orderItemDecisions
          })
        });
        await render();
      } catch (_err) {}
    }

    async function deliverOrdersByNos(orderNos) {
      if (!orderNos.length) return;
      const setNos = new Set(orderNos);
      const ids = currentFilteredOrders
        .filter(function (order) { return setNos.has(order.orderNo); })
        .map(function (order) { return order.id; })
        .filter(Boolean);
      if (!ids.length) return;
      try {
        for (const id of ids) {
          await apiRequest("/orders/" + encodeURIComponent(id) + "/deliver", { method: "PUT" });
        }
        await render();
      } catch (_err) {}
    }

    async function deliverAllApprovedForSelectedDate() {
      const firstConfirm = await showConfirmDialog(
        "Toplu Teslim Onayi",
        "Secili tarihteki onayli siparislerin tumunu teslim edildi olarak isaretlemek istediginize emin misiniz?",
        "Evet",
        "Hayir"
      );
      if (!firstConfirm) return;
      const secondConfirm = await showConfirmDialog(
        "Son Onay",
        "Bu islem ile onayli siparisler teslim edildi olarak kaydedilecek. Devam etmek istiyor musunuz?",
        "Tamam",
        "Vazgec"
      );
      if (!secondConfirm) return;

      const approvedNos = currentFilteredOrders
        .filter(function (order) {
          const st = normalizeStatus(order.status);
          return (st === "Onaylandi" || st === "Kismen Onaylandi") &&
            normalizeDeliveryStatus(order.deliveryStatus) !== "Teslim Edildi";
        })
        .map(function (order) { return order.orderNo; })
        .filter(Boolean);

      if (!approvedNos.length) {
        await showInfoDialog("Bilgi", "Teslim edilecek onayli siparis bulunmuyor.", "Kapat");
        return;
      }

      await deliverOrdersByNos(approvedNos);
      await showInfoDialog("Basarili", "Tum onayli siparisler teslim edildi olarak isaretlendi.", "Kapat");
    }

    function updateDeliverAllButtonState(approvableOrderCount, deliveryPendingCount) {
      deliverAllBtn.classList.remove("warn", "success");
      if (deliveryPendingCount > 0) {
        deliverAllBtn.classList.add("warn");
        deliverAllBtn.textContent = "Tamami Teslim Edildi";
        deliverAllBtn.disabled = false;
        return;
      }

      if (approvableOrderCount > 0) {
        deliverAllBtn.classList.add("success");
        deliverAllBtn.textContent = "Tum siparisler teslim edildi";
        deliverAllBtn.disabled = true;
        return;
      }

      deliverAllBtn.classList.add("warn");
      deliverAllBtn.textContent = "Tamami Teslim Edildi";
      deliverAllBtn.disabled = true;
    }

    function updateApproveAllButtonState(pending, partial, rejected, approved) {
      approveAllBtn.classList.remove("warn", "success");
      if (approved > 0 && pending === 0 && partial === 0 && rejected === 0) {
        approveAllBtn.classList.add("success");
        return;
      }
      approveAllBtn.classList.add("warn");
    }

    setTodayFilter();
    render();
    approveSelectedBtn.addEventListener("click", approveSelected);
    rejectSelectedBtn.addEventListener("click", rejectSelected);
    approveAllBtn.addEventListener("click", approveAllForSelectedDate);
    deliverAllBtn.addEventListener("click", function () {
      deliverAllApprovedForSelectedDate().catch(function () {});
    });
    refreshBtn.addEventListener("click", render);
    dateFilter.addEventListener("change", function () {
      selectAllOrders.checked = false;
      render();
    });
    todayBtn.addEventListener("click", function () {
      setTodayFilter();
      selectAllOrders.checked = false;
      render();
    });
    selectAllOrders.addEventListener("change", function () {
      const checked = selectAllOrders.checked;
      document.querySelectorAll(".order-check:not(:disabled)").forEach(function (cb) {
        cb.checked = checked;
      });
      syncSelectAllState();
    });
  </script>
</body>
</html>










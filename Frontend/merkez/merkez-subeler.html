<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merkez Sube Yonetimi | B2B Tedarik</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Fraunces:opsz,wght@9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f3ede0;
      --bg-2: #d8f0e3;
      --ink: #13221f;
      --card: rgba(255, 255, 255, 0.74);
      --border: rgba(19, 34, 31, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #fef6d8 0%, transparent 40%),
        radial-gradient(circle at 85% 20%, #d4f6eb 0%, transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 1.2rem;
    }
    .wrap { width: min(1180px, 100%); margin: 0 auto; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: clamp(1rem, 2.2vw, 1.8rem);
      box-shadow: 0 24px 60px rgba(19, 34, 31, 0.12);
    }
    .top {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 1rem;
      align-items: start;
      margin-bottom: 1rem;
    }
    h1 {
      margin: .7rem 0 .3rem;
      font-family: "Fraunces", serif;
      font-size: clamp(1.85rem, 4.3vw, 2.9rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }
    .eyebrow {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .3rem .7rem;
      font-size: .8rem;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.65);
    }
    .nav {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-content: flex-start;
      justify-content: flex-end;
      margin-left: auto;
    }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .75rem;
      background: rgba(255, 255, 255, .72);
      font-weight: 600;
      height: fit-content;
    }
    @media (max-width: 980px) {
      .top {
        grid-template-columns: 1fr;
      }
      .nav {
        justify-content: flex-start;
        margin-left: 0;
      }
    }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: .9rem;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255, 255, 255, .68);
      padding: .9rem;
    }
    .branch-list {
      display: grid;
      gap: .45rem;
      max-height: 68vh;
      overflow: auto;
      padding-right: .2rem;
    }
    .branch-btn {
      border: 1px solid var(--border);
      border-radius: 11px;
      background: rgba(255, 255, 255, .82);
      color: var(--ink);
      padding: .55rem .65rem;
      text-align: left;
      cursor: pointer;
      font: inherit;
      font-weight: 600;
    }
    .branch-btn.passive {
      background: rgba(232, 111, 81, .12);
      border-color: rgba(232, 111, 81, .38);
    }
    .branch-btn.active {
      background: #13221f;
      color: #fff;
      border-color: transparent;
    }
    .field {
      margin-bottom: .6rem;
      font-size: .95rem;
    }
    .field strong {
      display: block;
      margin-bottom: .1rem;
      font-size: .85rem;
      opacity: .8;
      letter-spacing: .02em;
    }
    .status-pill {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .2rem .55rem;
      font-size: .82rem;
      font-weight: 700;
      background: rgba(216, 240, 227, .9);
    }
    .status-pill.passive {
      background: rgba(232, 111, 81, .18);
      border-color: rgba(232, 111, 81, .4);
    }
    .control-row {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
      margin: .7rem 0;
    }
    .control-row input {
      width: 120px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .6rem .7rem;
      font: inherit;
      background: rgba(255, 255, 255, .88);
    }
    .btn {
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .72rem;
      background: rgba(255, 255, 255, .84);
      color: var(--ink);
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.primary {
      background: var(--ink);
      color: #fff;
      border-color: transparent;
    }
    .preview {
      border: 1px dashed rgba(19, 34, 31, .25);
      border-radius: 12px;
      padding: .65rem .75rem;
      background: rgba(255, 255, 255, .76);
      margin-top: .5rem;
      font-size: .92rem;
    }
    .adjust-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .45rem;
      font-size: .9rem;
    }
    .adjust-table th, .adjust-table td {
      border-bottom: 1px solid rgba(19, 34, 31, .12);
      padding: .42rem .3rem;
      text-align: left;
      vertical-align: middle;
    }
    .adjust-table th {
      font-size: .82rem;
      opacity: .8;
    }
    .adjust-table input {
      width: 110px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .45rem .55rem;
      font: inherit;
      background: rgba(255, 255, 255, .9);
    }
    .adjust-table input.editing {
      border-color: rgba(232, 111, 81, .95);
      box-shadow: 0 0 0 3px rgba(232, 111, 81, .18);
      background: rgba(255, 248, 241, .96);
    }
    .adjust-actions {
      display: flex;
      gap: .35rem;
      align-items: center;
    }
    .btn.icon {
      width: 36px;
      min-width: 36px;
      padding: .4rem 0;
      text-align: center;
      font-size: .95rem;
    }
    .adjust-table tr:last-child td {
      border-bottom: 0;
    }
    .confirm-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(19, 34, 31, .28);
      backdrop-filter: blur(2px);
      z-index: 80;
      padding: 1rem;
    }
    .confirm-modal.show { display: flex; }
    .confirm-card {
      width: min(420px, 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, .98);
      box-shadow: 0 12px 34px rgba(19, 34, 31, .2);
      padding: .9rem 1rem;
    }
    .confirm-card h4 {
      margin: .1rem 0 .4rem;
      font-size: 1rem;
    }
    .confirm-card p {
      margin: 0 0 .7rem;
      font-size: .92rem;
    }
    .confirm-row {
      display: flex;
      gap: .5rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .list {
      margin: .45rem 0 0;
      padding-left: 1.1rem;
    }
    .msg {
      display: none;
      margin-top: .65rem;
      border: 1px solid rgba(19, 34, 31, .2);
      background: rgba(216, 240, 227, .78);
      border-radius: 11px;
      padding: .6rem .7rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="panel">
      <div class="top">
        <div>
          <h1>Sube Listesi ve Ozel Fiyat Farki</h1>
        </div>
        <nav class="nav">
          <a href="merkez.html">Merkez Paneli</a>
          <a href="merkez-raporlar.html">Raporlar</a>
          <a href="merkez-urun-fiyat.html">Urunler</a>
          <a href="merkez-subeler.html">Subeler</a>
        </nav>
      </div>

      <section class="layout">
        <article class="card">
          <h3>Subeler (<span id="branchCount">0</span>)</h3>
          <div class="branch-list" id="branchList"></div>
        </article>

        <article class="card">
          <h3>Sube Detayi</h3>
          <div class="field"><strong>Sube Adi</strong><span id="dName">-</span></div>
          <div class="field"><strong>Yetkili</strong><span id="dManager">-</span></div>
          <div class="field"><strong>Telefon</strong><span id="dPhone">-</span></div>
          <div class="field"><strong>E-posta</strong><span id="dEmail">-</span></div>
          <div class="field"><strong>Adres</strong><span id="dAddress">-</span></div>
          <div class="field"><strong>Durum</strong><span id="dStatus" class="status-pill">Aktif</span></div>
          <div class="control-row">
            <button class="btn primary" id="setActiveBtn" type="button">Aktif Yap</button>
            <button class="btn" id="setPassiveBtn" type="button">Pasif Yap</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(19,34,31,.15);margin:.8rem 0;">

          <div class="field"><strong>Sube Fiyat Farki (%)</strong></div>
          <div class="control-row">
            <button class="btn" id="minusBtn" type="button">-</button>
            <input id="percentInput" type="number" step="0.5" min="-90" max="200">
            <button class="btn" id="plusBtn" type="button">+</button>
            <button class="btn" id="applyBtn" type="button">Fiyat Farki Uygula</button>
            <button class="btn primary" id="saveBtn" type="button">Kaydet</button>
          </div>

          <div class="preview">
            <strong>Urun Bazli Ek Fiyat Farki (TL)</strong>
            <table class="adjust-table">
              <thead>
                <tr>
                  <th>Urun</th>
                  <th>Baz</th>
                  <th>Ek Fark</th>
                  <th>Son Fiyat</th>
                  <th>Islem</th>
                </tr>
              </thead>
              <tbody id="productAdjustBody"></tbody>
            </table>
            <strong style="display:block;margin-top:.5rem;">Onizleme (tepsi fiyati)</strong>
            <ul class="list" id="pricePreview"></ul>
          </div>
          <div class="msg" id="saveMsg">Sube fiyat farki kaydedildi.</div>
        </article>
      </section>
    </main>
  </div>

  <script src="../assets/app-config.js?v=20260226b"></script>
  <script src="../assets/role-guard.js"></script>
  <div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true">
    <div class="confirm-card">
      <h4>Degisikligi Onayla</h4>
      <p id="confirmText">Urun fiyat farkini guncellemek istediginize emin misiniz?</p>
      <div class="confirm-row">
        <button id="confirmCancelBtn" class="btn" type="button">Iptal</button>
        <button id="confirmOkBtn" class="btn primary" type="button">Tamam</button>
      </div>
    </div>
  </div>
  <script>
    const branchListEl = document.getElementById("branchList");
    const branchCountEl = document.getElementById("branchCount");
    const dName = document.getElementById("dName");
    const dManager = document.getElementById("dManager");
    const dPhone = document.getElementById("dPhone");
    const dEmail = document.getElementById("dEmail");
    const dAddress = document.getElementById("dAddress");
    const dStatus = document.getElementById("dStatus");
    const setActiveBtn = document.getElementById("setActiveBtn");
    const setPassiveBtn = document.getElementById("setPassiveBtn");
    const percentInput = document.getElementById("percentInput");
    const minusBtn = document.getElementById("minusBtn");
    const plusBtn = document.getElementById("plusBtn");
    const applyBtn = document.getElementById("applyBtn");
    const saveBtn = document.getElementById("saveBtn");
    const pricePreview = document.getElementById("pricePreview");
    const productAdjustBody = document.getElementById("productAdjustBody");
    const saveMsg = document.getElementById("saveMsg");
    const confirmModal = document.getElementById("confirmModal");
    const confirmText = document.getElementById("confirmText");
    const confirmCancelBtn = document.getElementById("confirmCancelBtn");
    const confirmOkBtn = document.getElementById("confirmOkBtn");

    const cfg = window.APP_CONFIG || {};
    const testMode = !!cfg.TEST_MODE;
    const apiBaseUrl = (cfg.API_BASE_URL || "http://localhost:4000/api").replace(/\/$/, "");
    const defaultBasePrices = {
      su_boregi: { name: "Su Boregi", price: 700 },
      peynirli_borek: { name: "Peynirli Borek", price: 650 },
      kiymali_borek: { name: "Kiymali Borek", price: 730 },
      patatesli_borek: { name: "Patatesli Borek", price: 610 },
      ispanakli_borek: { name: "Ispanakli Borek", price: 640 },
      kasarli_borek: { name: "Kasarli Borek", price: 680 },
      kol_boregi: { name: "Kol Boregi", price: 760 },
      karisik_borek: { name: "Karisik Borek", price: 790 }
    };

    let branches = [];
    let products = [];
    let selectedBranchId = null;
    let branchProductRows = [];
    let editingProductId = null;
    let pendingProductAdjustment = null;

    function getAuthSession() {
      try {
        return window.AuthSession && window.AuthSession.get ? window.AuthSession.get() : null;
      } catch (_err) {
        return null;
      }
    }

    async function apiRequest(path, options) {
      const session = getAuthSession();

      const response = await fetch(apiBaseUrl + path, Object.assign({}, options || {}, {
        credentials: "include",
        headers: Object.assign(
          { "Content-Type": "application/json" },
          (options && options.headers) || {}
        )
      }));

      const payload = await response.json().catch(function () { return null; });
      if (!response.ok || !payload || payload.ok !== true) {
        throw new Error((payload && payload.message) || "API islemi basarisiz.");
      }
      return payload.data;
    }

    function getSelectedBranch() {
      return branches.find(function (b) { return b.id === selectedBranchId; }) || null;
    }

    function applyPercent(base, percent) {
      return Math.max(1, Math.round(base * (1 + percent / 100)));
    }

    function renderBranchList() {
      branchCountEl.textContent = String(branches.length);
      const html = branches.map(function (branch) {
        const isSelected = selectedBranchId === branch.id ? "active" : "";
        const passive = branch.isActive ? "" : "passive";
        const statusText = branch.isActive ? "Aktif" : "Pasif";
        return '<button class="branch-btn ' + isSelected + " " + passive + '" type="button" data-branch-id="' + branch.id + '">' + branch.name + " (" + statusText + ')</button>';
      }).join("");
      branchListEl.innerHTML = html;

      branchListEl.querySelectorAll(".branch-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          selectedBranchId = btn.dataset.branchId || null;
          renderSelectedBranch();
          renderBranchList();
        });
      });
    }

    function getPreviewProducts() {
      if (branchProductRows.length) {
        return branchProductRows.map(function (row) {
          return {
            name: row.name,
            basePrice: Number(row.basePrice || 0),
            extraAmount: Number(row.extraAmount || 0)
          };
        });
      }
      if (!testMode && products.length) {
        return products.map(function (p) {
          return { name: p.name, basePrice: Number(p.basePrice || 0), extraAmount: 0 };
        });
      }
      return Object.keys(defaultBasePrices).map(function (key) {
        return {
          name: defaultBasePrices[key].name,
          basePrice: Number(defaultBasePrices[key].price),
          extraAmount: 0
        };
      });
    }

    function renderPreview() {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) {
        pricePreview.innerHTML = "";
        return;
      }
      const pct = Number(percentInput.value || 0);
      const previewHtml = getPreviewProducts().map(function (product) {
        const extra = Number(product.extraAmount || 0);
        const adjusted = Math.max(1, Math.round((Number(product.basePrice) * (1 + pct / 100)) + extra));
        return "<li>" + product.name + ": " + adjusted + " TL</li>";
      }).join("");
      pricePreview.innerHTML = previewHtml;
    }

    function renderProductAdjustmentTable() {
      if (!branchProductRows.length) {
        productAdjustBody.innerHTML = '<tr><td colspan="5">Urun bilgisi bulunamadi.</td></tr>';
        return;
      }
      productAdjustBody.innerHTML = branchProductRows.map(function (row) {
        const isEditing = editingProductId === row.productId;
        const safeName = (row.name || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
        return '' +
          '<tr>' +
          '  <td>' + safeName + '</td>' +
          '  <td>' + Math.round(Number(row.basePrice || 0)) + ' TL</td>' +
          '  <td><input class="' + (isEditing ? 'editing' : '') + '" type="number" step="1" min="-100000" max="100000" data-product-id="' + row.productId + '" value="' + Number(row.extraAmount || 0) + '" ' + (isEditing ? '' : 'disabled') + '></td>' +
          '  <td>' + Math.round(Number(row.adjustedPrice || 0)) + ' TL</td>' +
          '  <td><div class="adjust-actions"><button class="btn icon edit-product-btn" type="button" data-product-id="' + row.productId + '">&#9998;</button><button class="btn primary save-product-btn" type="button" data-product-id="' + row.productId + '" ' + (isEditing ? '' : 'disabled') + '>Kaydet</button></div></td>' +
          '</tr>';
      }).join("");

      productAdjustBody.querySelectorAll(".edit-product-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          editingProductId = btn.dataset.productId || null;
          renderProductAdjustmentTable();
        });
      });

      productAdjustBody.querySelectorAll(".save-product-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const productId = btn.dataset.productId || "";
          if (!productId || editingProductId !== productId) return;
          const input = productAdjustBody.querySelector('input[data-product-id="' + productId + '"]');
          if (!input) return;
          const value = Number(input.value || 0);
          const row = branchProductRows.find(function (x) { return x.productId === productId; });
          if (!row) return;
          pendingProductAdjustment = { productId: productId, productName: row.name, extraAmount: value };
          confirmText.textContent = row.name + " icin ek fiyat farki " + value + " TL olarak guncellenecek. Kararinizdan emin misiniz?";
          confirmModal.classList.add("show");
        });
      });
    }

    async function loadProductAdjustments() {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) {
        branchProductRows = [];
        renderProductAdjustmentTable();
        return;
      }
      if (!testMode) {
        const data = await apiRequest("/branches/" + selectedBranch.id + "/product-adjustments", { method: "GET" });
        branchProductRows = Array.isArray(data.products) ? data.products : [];
      } else {
        branchProductRows = getPreviewProducts().map(function (product, idx) {
          return {
            productId: "local-p-" + idx,
            name: product.name,
            basePrice: Number(product.basePrice || 0),
            extraAmount: 0,
            adjustedPrice: applyPercent(Number(product.basePrice || 0), Number(percentInput.value || 0))
          };
        });
      }
      renderProductAdjustmentTable();
      renderPreview();
    }

    async function saveProductAdjustment(productId, extraAmount) {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) return;
      editingProductId = null;

      if (!testMode) {
        await apiRequest("/branches/" + selectedBranch.id + "/product-adjustments/" + productId, {
          method: "PUT",
          body: JSON.stringify({ extraAmount: Number(extraAmount || 0) })
        });
        await loadProductAdjustments();
      } else {
        branchProductRows = branchProductRows.map(function (row) {
          if (row.productId === productId) {
            const pct = Number(percentInput.value || 0);
            const finalPrice = Math.max(1, Math.round((Number(row.basePrice || 0) * (1 + pct / 100)) + Number(extraAmount || 0)));
            return Object.assign({}, row, { extraAmount: Number(extraAmount || 0), adjustedPrice: finalPrice });
          }
          return row;
        });
        renderProductAdjustmentTable();
        renderPreview();
      }
      renderProductAdjustmentTable();
      showMessage("Urun bazli fiyat farki kaydedildi.");
    }

    function renderSelectedBranch() {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) {
        dName.textContent = "-";
        dManager.textContent = "-";
        dPhone.textContent = "-";
        dEmail.textContent = "-";
        dAddress.textContent = "-";
        dStatus.textContent = "-";
        dStatus.className = "status-pill";
        percentInput.value = "0";
        renderPreview();
        return;
      }
      const pct = Number(selectedBranch.priceAdjustmentPercent || 0);
      dName.textContent = selectedBranch.name;
      dManager.textContent = selectedBranch.manager;
      dPhone.textContent = selectedBranch.phone;
      dEmail.textContent = selectedBranch.userEmail || selectedBranch.email || "-";
      dAddress.textContent = selectedBranch.address;
      dStatus.textContent = selectedBranch.isActive ? "Aktif" : "Pasif";
      dStatus.className = selectedBranch.isActive ? "status-pill" : "status-pill passive";
      percentInput.value = String(pct);
      renderPreview();
      loadProductAdjustments().catch(function (err) {
        showMessage((err && err.message) || "Urun bazli fiyat farklari alinamadi.");
      });
    }

    async function setSelectedBranchActive(isActive) {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) return;

      if (!testMode) {
        try {
          const updated = await apiRequest("/branches/" + selectedBranch.id + "/status", {
            method: "PUT",
            body: JSON.stringify({ isActive: !!isActive })
          });
          branches = branches.map(function (b) {
            return b.id === updated.id ? updated : b;
          });
        } catch (err) {
          showMessage(err.message || "Sube durumu guncellenemedi.");
          return;
        }
      } else {
        branches = branches.map(function (b) {
          if (b.id === selectedBranch.id) return Object.assign({}, b, { isActive: !!isActive });
          return b;
        });
      }

      renderSelectedBranch();
      renderBranchList();
      showMessage(isActive ? "Sube aktif yapildi." : "Sube pasif yapildi.");
    }

    function showMessage(text) {
      saveMsg.style.display = "block";
      saveMsg.textContent = text;
      setTimeout(function () {
        saveMsg.style.display = "none";
        saveMsg.textContent = "Sube fiyat farki kaydedildi.";
      }, 2200);
    }

    async function saveSelectedBranchAdjustment() {
      const selectedBranch = getSelectedBranch();
      if (!selectedBranch) return;
      const pct = Number(percentInput.value || 0);

      if (!testMode) {
        try {
          const updated = await apiRequest("/branches/" + selectedBranch.id + "/price-adjustment", {
            method: "PUT",
            body: JSON.stringify({ percent: pct })
          });
          branches = branches.map(function (b) {
            return b.id === updated.id ? updated : b;
          });
        } catch (err) {
          showMessage(err.message || "Fiyat farki kaydedilemedi.");
          return;
        }
      } else {
        branches = branches.map(function (b) {
          if (b.id === selectedBranch.id) return Object.assign({}, b, { priceAdjustmentPercent: pct });
          return b;
        });
      }

      renderSelectedBranch();
      renderBranchList();
      await loadProductAdjustments();
      showMessage("Sube fiyat farki kaydedildi.");
    }

    minusBtn.addEventListener("click", function () {
      percentInput.value = String((Number(percentInput.value || 0) - 1).toFixed(1));
      renderPreview();
    });
    plusBtn.addEventListener("click", function () {
      percentInput.value = String((Number(percentInput.value || 0) + 1).toFixed(1));
      renderPreview();
    });
    applyBtn.addEventListener("click", renderPreview);
    saveBtn.addEventListener("click", saveSelectedBranchAdjustment);
    percentInput.addEventListener("input", renderPreview);
    setActiveBtn.addEventListener("click", function () { setSelectedBranchActive(true); });
    setPassiveBtn.addEventListener("click", function () { setSelectedBranchActive(false); });

    confirmCancelBtn.addEventListener("click", function () {
      pendingProductAdjustment = null;
      confirmModal.classList.remove("show");
    });

    confirmOkBtn.addEventListener("click", function () {
      if (!pendingProductAdjustment) {
        confirmModal.classList.remove("show");
        return;
      }
      const payload = pendingProductAdjustment;
      pendingProductAdjustment = null;
      confirmModal.classList.remove("show");
      saveProductAdjustment(payload.productId, payload.extraAmount).catch(function (err) {
        showMessage((err && err.message) || "Urun bazli fiyat farki kaydedilemedi.");
      });
    });

    confirmModal.addEventListener("click", function (event) {
      if (event.target === confirmModal) {
        pendingProductAdjustment = null;
        confirmModal.classList.remove("show");
      }
    });

    function loadLocalFallbackData() {
      const list = [];
      for (let i = 1; i <= 5; i += 1) {
        const no = String(i).padStart(2, "0");
        list.push({
          id: "local-" + no,
          name: "Borekci Sube " + no,
          manager: "Yetkili " + no,
          phone: "0555 100 " + no + " " + no,
          email: "sube" + no + "@ornek.com",
          userEmail: "sube" + no + "@borekci.com",
          address: "Ornek Mah. Borek Sok. No:" + i,
          isActive: true,
          priceAdjustmentPercent: 0
        });
      }
      branches = list;
      products = getPreviewProducts();
      selectedBranchId = branches.length ? branches[0].id : null;
      renderBranchList();
      renderSelectedBranch();
      loadProductAdjustments();
    }

    async function initApiMode() {
      branches = await apiRequest("/branches", { method: "GET" });
      products = await apiRequest("/products", { method: "GET" });
      selectedBranchId = branches.length ? branches[0].id : null;
      renderBranchList();
      renderSelectedBranch();
    }

    if (!testMode) {
      initApiMode().catch(function (err) {
        showMessage((err && err.message) || "Sube bilgileri API'den alinamadi.");
      });
    } else {
      loadLocalFallbackData();
    }
  </script>
</body>
</html>










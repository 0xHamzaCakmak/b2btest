<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Siparislerim | B2B Tedarik</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Fraunces:opsz,wght@9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f3ede0;
      --bg-2: #d8f0e3;
      --ink: #13221f;
      --accent: #e86f51;
      --card: rgba(255, 255, 255, 0.74);
      --border: rgba(19, 34, 31, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #fef6d8 0%, transparent 40%),
        radial-gradient(circle at 85% 20%, #d4f6eb 0%, transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 1.2rem;
    }
    .blob {
      position: fixed;
      z-index: -1;
      width: 35vmax;
      aspect-ratio: 1;
      border-radius: 42% 58% 70% 30% / 30% 41% 59% 70%;
      background: color-mix(in srgb, var(--accent) 60%, #fff);
      filter: blur(30px);
      opacity: 0.26;
      animation: drift 14s ease-in-out infinite alternate;
    }
    .blob.one { top: -8vmax; left: -10vmax; }
    .blob.two { bottom: -12vmax; right: -8vmax; animation-delay: 2s; }
    @keyframes drift {
      from { transform: translateY(-10px) rotate(0deg); }
      to { transform: translateY(12px) rotate(18deg); }
    }
    .wrap { width: min(1000px, 100%); margin: 0 auto; }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: clamp(1rem, 2.2vw, 1.9rem);
      box-shadow: 0 24px 60px rgba(19, 34, 31, 0.12);
    }
    .top {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    h1 {
      margin: .7rem 0 .3rem;
      font-family: "Fraunces", serif;
      font-size: clamp(1.8rem, 4.4vw, 2.8rem);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }
    .eyebrow {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .3rem .7rem;
      font-size: .8rem;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.65);
    }
    .nav {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-content: flex-start;
      align-items: flex-start;
    }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: .5rem .75rem;
      background: rgba(255, 255, 255, .72);
      font-weight: 600;
      height: fit-content;
    }
    .list {
      display: grid;
      gap: .8rem;
      margin-top: 1rem;
    }
    .toolbar {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
      align-items: center;
      margin-top: .4rem;
    }
    .toolbar input {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .85);
      border-radius: 10px;
      padding: .45rem .55rem;
      font: inherit;
    }
    .btn {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .45rem .62rem;
      background: rgba(255, 255, 255, .82);
      color: var(--ink);
      font: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .hint {
      margin-top: .45rem;
      font-size: .88rem;
      font-weight: 600;
      opacity: .8;
    }
    .order {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255, 255, 255, .67);
      padding: .9rem;
    }
    .line {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: .95rem;
    }
    .items {
      margin-top: .6rem;
      border-top: 1px dashed rgba(19, 34, 31, .2);
      padding-top: .55rem;
      font-size: .92rem;
    }
    .items-table-wrap {
      margin-top: .55rem;
      overflow: auto;
      border: 1px solid rgba(19, 34, 31, .12);
      border-radius: 12px;
      background: rgba(255, 255, 255, .86);
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 620px;
      font-size: .88rem;
    }
    .items-table th,
    .items-table td {
      border-bottom: 1px solid rgba(19, 34, 31, .1);
      padding: .42rem .5rem;
      text-align: left;
      vertical-align: middle;
    }
    .items-table th {
      background: rgba(255, 255, 255, .95);
      font-weight: 700;
    }
    .item-row-rejected {
      color: #b4232a;
      font-weight: 700;
      background: rgba(255, 238, 238, .82);
    }
    .item-status {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .12rem .45rem;
      font-size: .74rem;
      font-weight: 700;
      display: inline-block;
      white-space: nowrap;
      background: rgba(255, 255, 255, .88);
    }
    .item-status.ok {
      background: rgba(216, 240, 227, .95);
    }
    .item-status.partial {
      background: rgba(255, 243, 221, .95);
      border-color: rgba(196, 143, 56, .35);
    }
    .item-status.reject {
      background: rgba(255, 231, 231, .95);
      border-color: rgba(191, 72, 72, .35);
      color: #8f1d23;
    }
    .badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .2rem .5rem;
      font-size: .82rem;
      background: rgba(255, 255, 255, .85);
      font-weight: 600;
    }
    .badge.ok {
      background: rgba(216, 240, 227, .95);
    }
    .badge.reject {
      background: rgba(255, 231, 231, .95);
      border-color: rgba(191, 72, 72, .35);
    }
    .badge.partial {
      background: rgba(255, 243, 221, .95);
      border-color: rgba(196, 143, 56, .35);
    }
    .badge.delivery {
      background: rgba(221, 242, 232, .95);
      border-color: rgba(74, 140, 92, .4);
    }
    .empty {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 1rem;
      background: rgba(255, 255, 255, .6);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="wrap">
    <main class="panel">
      <div class="top">
        <div>
          <h1>Siparislerim</h1>
        </div>
        <nav class="nav">
          <a href="siparis.html">Siparis Ver</a>
          <a href="siparislerim.html">Siparislerim</a>
          <a href="../merkez/merkez.html">Merkez Paneli</a>
        </nav>
      </div>

      <section class="toolbar">
        <label>Baslangic Tarihi <input type="date" id="fromDate"></label>
        <label>Bitis Tarihi <input type="date" id="toDate"></label>
        <button class="btn" type="button" id="applyFilterBtn">Filtrele</button>
        <button class="btn" type="button" id="todayBtn">Bugunu Goster</button>
        <button class="btn" type="button" id="clearFilterBtn">Temizle</button>
      </section>
      <div class="hint" id="filterHint"></div>
      <section class="list" id="orderList"></section>
    </main>
  </div>

  <script src="../assets/app-config.js?v=20260226"></script>
  <script src="../assets/role-guard.js"></script>
  <script>
    const orderList = document.getElementById("orderList");
    const cfg = window.APP_CONFIG || {};
    const apiBaseUrl = (cfg.API_BASE_URL || "http://localhost:4000/api").replace(/\/$/, "");    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const todayBtn = document.getElementById("todayBtn");
    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const filterHint = document.getElementById("filterHint");

    function formatTL(value) {
      return new Intl.NumberFormat("tr-TR").format(value) + " TL";
    }

    function formatDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString("tr-TR");
    }

    function escapeHtml(text) {
      return String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function getAuthSession() {
      try {
        return window.AuthSession && window.AuthSession.get ? window.AuthSession.get() : null;
      } catch (_err) {
        return null;
      }
    }

    async function apiRequest(path, options) {
      const session = getAuthSession();
      const response = await fetch(apiBaseUrl + path, Object.assign({}, options || {}, {
        credentials: "include",
        headers: Object.assign(
          { "Content-Type": "application/json" },
          (options && options.headers) || {}
        )
      }));
      const payload = await response.json().catch(function () { return null; });
      if (!response.ok || !payload || payload.ok !== true) {
        throw new Error((payload && payload.message) || "API islemi basarisiz.");
      }
      return payload.data;
    }

    function normalizeOrder(order) {
      return {
        orderNo: order.orderNo,
        status: order.status,
        deliveryDate: order.deliveryDate,
        deliveryTime: order.deliveryTime,
        createdAt: order.createdAt,
        deliveryStatus: order.deliveryStatus || "Teslim Bekliyor",
        deliveredAt: order.deliveredAt || null,
        deliveredByName: order.deliveredByName || null,
        totalTray: Number(order.totalTray || 0),
        totalAmount: Number(order.totalAmount || 0),
        items: (order.items || []).map(function (item) {
          return {
            name: item.name,
            qty: Number(item.qty || 0),
            unitPrice: Number(item.unitPrice || 0),
            approvedQty: item.approvedQty === null || item.approvedQty === undefined ? null : Number(item.approvedQty),
            itemStatus: item.itemStatus || ""
          };
        })
      };
    }

    function todayKey() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function toDateKey(value) {
      if (!value) return "";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return yyyy + "-" + mm + "-" + dd;
    }

    function setHint(text) {
      filterHint.textContent = text || "";
    }

    function setTodayFilter() {
      const today = todayKey();
      fromDate.value = today;
      toDate.value = today;
    }

    function validateRange() {
      const from = fromDate.value || "";
      const to = toDate.value || "";
      if (from && to && from > to) return false;
      return true;
    }

    function renderOrders(orders) {

      if (!orders.length) {
        orderList.innerHTML = '<div class="empty">Henuz siparis bulunmuyor. Once siparis olustur.</div>';
        return;
      }

      const html = orders
        .slice()
        .sort(function (a, b) {
          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
        })
        .map(function (order) {
          const statusText = order.status === "Onaylandi"
            ? "Onaylandi"
            : (order.status === "Kismen Onaylandi"
              ? "Kismen Onaylandi"
              : (order.status === "Onaylanmadi" ? "Onaylanmadi" : "Onay Bekliyor"));
          const statusClass = statusText === "Onaylandi"
            ? "badge ok"
            : (statusText === "Onaylanmadi" ? "badge reject" : (statusText === "Kismen Onaylandi" ? "badge partial" : "badge"));
          const deliveryText = String(order.deliveryStatus || "").toLowerCase() === "teslim edildi" ? "Teslim Edildi" : "Teslim Bekliyor";
          const deliveryClass = deliveryText === "Teslim Edildi" ? "badge delivery" : "badge";
          const itemRows = order.items.map(function (item) {
            const itemStatus = item.itemStatus || (statusText === "Onay Bekliyor" ? "Onay Bekliyor" : (statusText === "Onaylanmadi" ? "Onaylanmadi" : "Onaylandi"));
            const approvedQty = item.approvedQty === null || item.approvedQty === undefined ? "-" : item.approvedQty;
            const rowClass = itemStatus === "Onaylanmadi" ? "item-row-rejected" : "";
            const itemStatusClass = itemStatus === "Onaylandi"
              ? "ok"
              : (itemStatus === "Kismen Onaylandi" ? "partial" : (itemStatus === "Onaylanmadi" ? "reject" : ""));
            return '' +
              '<tr class="' + rowClass + '">' +
              '<td>' + escapeHtml(item.name) + '</td>' +
              '<td>' + item.qty + ' tepsi</td>' +
              '<td>' + approvedQty + ' tepsi</td>' +
              '<td>' + escapeHtml(formatTL(item.unitPrice)) + '</td>' +
              '<td><span class="item-status ' + itemStatusClass + '">' + escapeHtml(itemStatus) + '</span></td>' +
              '</tr>';
          }).join("");
          const items = '' +
            '<div class="items-table-wrap">' +
            '  <table class="items-table">' +
            '    <thead><tr><th>Urun</th><th>Talep</th><th>Onay</th><th>Birim Fiyat</th><th>Durum</th></tr></thead>' +
            '    <tbody>' + itemRows + '</tbody>' +
            '  </table>' +
            '</div>';
          const deliveryMeta = deliveryText === "Teslim Edildi"
            ? ('<div class="line"><span><strong>Teslim Bilgisi:</strong> ' + formatDate(order.deliveredAt) + '</span><span>Yetkili: ' + (order.deliveredByName || "-") + '</span></div>')
            : "";

          return '' +
            '<article class="order">' +
            '  <div class="line"><strong>Siparis No: ' + order.orderNo + '</strong><span class="' + statusClass + '">' + statusText + '</span></div>' +
            '  <div class="line"><span class="' + deliveryClass + '">' + deliveryText + '</span></div>' +
            '  <div class="line"><span>Teslimat: ' + (order.deliveryDate || "-") + ' ' + (order.deliveryTime || "") + '</span><span>Olusturma: ' + formatDate(order.createdAt) + '</span></div>' +
            deliveryMeta +
            '  <div class="line"><span>Toplam Tepsi: ' + order.totalTray + '</span><strong>Toplam: ' + formatTL(order.totalAmount) + '</strong></div>' +
            '  <div class="items"><strong>Siparis Kalemleri</strong>' + items + '</div>' +
            '</article>';
        })
        .join("");

      orderList.innerHTML = html;
    }

    async function loadOrders() {
      if (!validateRange()) {
        orderList.innerHTML = '<div class="empty">Baslangic tarihi, bitis tarihinden buyuk olamaz.</div>';
        return;
      }
      try {
        const params = new URLSearchParams();
        if (fromDate.value) params.set("from", fromDate.value);
        if (toDate.value) params.set("to", toDate.value);
        const query = params.toString();
        const data = await apiRequest("/orders/my" + (query ? "?" + query : ""), { method: "GET" });
        renderOrders((data || []).map(normalizeOrder));
        if (fromDate.value && toDate.value && fromDate.value === toDate.value) {
          setHint("Secili gun siparisleri gosteriliyor: " + fromDate.value);
        } else if (fromDate.value || toDate.value) {
          setHint("Secili tarih araligi filtrelendi.");
        } else {
          setHint("Tum siparisler listeleniyor.");
        }
      } catch (err) {
        orderList.innerHTML = '<div class="empty">' + ((err && err.message) || "Siparisler alinamadi.") + '</div>';
      }
    }

    async function init() {
      setTodayFilter();
      await loadOrders();
    }

    init();
    applyFilterBtn.addEventListener("click", loadOrders);
    todayBtn.addEventListener("click", function () {
      setTodayFilter();
      loadOrders();
    });
    clearFilterBtn.addEventListener("click", function () {
      fromDate.value = "";
      toDate.value = "";
      loadOrders();
    });
  </script>
</body>
</html>








